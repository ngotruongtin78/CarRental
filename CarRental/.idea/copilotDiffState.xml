<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/main/java/controller/StaffDeliverController.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/controller/StaffDeliverController.java" />
              <option name="originalContent" value="package CarRental.example.controller;&#10;&#10;import CarRental.example.document.RentalRecord;&#10;import CarRental.example.document.Vehicle;&#10;import CarRental.example.document.Staff;&#10;import CarRental.example.repository.RentalRecordRepository;&#10;import CarRental.example.repository.VehicleRepository;&#10;import CarRental.example.repository.StaffRepository;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.http.ResponseEntity;&#10;import org.springframework.security.core.Authentication;&#10;import org.springframework.security.core.context.SecurityContextHolder;&#10;import org.springframework.security.core.userdetails.UserDetails;&#10;import org.springframework.web.bind.annotation.*;&#10;import jakarta.servlet.http.HttpServletRequest;&#10;&#10;import java.util.*;&#10;&#10;@RestController&#10;@RequestMapping(&quot;/api/staff/deliver&quot;)&#10;@CrossOrigin(origins = &quot;*&quot;)&#10;public class StaffDeliverController {&#10;&#10;    @Autowired&#10;    private RentalRecordRepository rentalRecordRepository;&#10;&#10;    @Autowired&#10;    private VehicleRepository vehicleRepository;&#10;&#10;    @Autowired&#10;    private StaffRepository staffRepository;&#10;&#10;    /**&#10;     * Lấy danh sách các xe sẵn sàng giao cho khách hàng&#10;     * Điều kiện:&#10;     * - RentalRecord có paymentStatus = &quot;PAID&quot; hoặc &quot;PAY_AT_STATION&quot;&#10;     * - RentalRecord.stationId = Staff.stationId (của staff hiện tại)&#10;     */&#10;    @GetMapping(&quot;/vehicles-ready&quot;)&#10;    public ResponseEntity&lt;?&gt; getVehiclesReadyForDelivery() {&#10;        try {&#10;            // Lấy thông tin staff hiện tại&#10;            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#10;&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Chưa xác thực. Vui lòng đăng nhập lại.&quot;));&#10;            }&#10;&#10;            String username = null;&#10;            Object principal = authentication.getPrincipal();&#10;&#10;            // Handle different types of principal&#10;            if (principal instanceof String) {&#10;                username = (String) principal;&#10;            } else if (principal instanceof UserDetails) {&#10;                username = ((UserDetails) principal).getUsername();&#10;            } else if (principal != null) {&#10;                username = principal.toString();&#10;            }&#10;&#10;            if (username == null || username.isEmpty() || &quot;anonymousUser&quot;.equals(username)) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy thông tin đăng nhập. Username: &quot; + username));&#10;            }&#10;&#10;            Staff staff = staffRepository.findByUsername(username);&#10;&#10;            if (staff == null) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy thông tin nhân viên trong database. Username: &quot; + username));&#10;            }&#10;&#10;            String staffStationId = staff.getStationId();&#10;&#10;            // Lọc RentalRecord:&#10;            // - paymentStatus = &quot;PAID&quot; hoặc &quot;PAY_AT_STATION&quot;&#10;            // - status != &quot;DELIVERED&quot; (chỉ hiển thị những xe chưa được giao)&#10;            // - stationId của hợp đồng = stationId của staff&#10;            List&lt;RentalRecord&gt; readyRecords = rentalRecordRepository.findAll().stream()&#10;                    .filter(record -&gt; (&quot;PAID&quot;.equals(record.getPaymentStatus()) ||&#10;                                     &quot;PAY_AT_STATION&quot;.equals(record.getPaymentStatus())) &amp;&amp;&#10;                                     !&quot;DELIVERED&quot;.equals(record.getStatus()) &amp;&amp;&#10;                                     staffStationId.equals(record.getStationId()))&#10;                    .toList();&#10;&#10;            List&lt;Map&lt;String, Object&gt;&gt; result = new ArrayList&lt;&gt;();&#10;&#10;            for (RentalRecord record : readyRecords) {&#10;                Vehicle vehicle = vehicleRepository.findById(record.getVehicleId()).orElse(null);&#10;                if (vehicle != null) {&#10;                    Map&lt;String, Object&gt; item = new LinkedHashMap&lt;&gt;();&#10;                    item.put(&quot;id&quot;, record.getId());&#10;                    item.put(&quot;vehiclePlate&quot;, vehicle.getPlate());&#10;                    item.put(&quot;vehicleType&quot;, vehicle.getType());&#10;                    item.put(&quot;username&quot;, record.getUsername());&#10;                    item.put(&quot;startDate&quot;, record.getStartDate());&#10;                    item.put(&quot;endDate&quot;, record.getEndDate());&#10;                    item.put(&quot;rentalDays&quot;, record.getRentalDays());&#10;                    item.put(&quot;total&quot;, record.getTotal());&#10;                    item.put(&quot;paymentStatus&quot;, record.getPaymentStatus());&#10;                    item.put(&quot;status&quot;, record.getStatus());&#10;                    result.add(item);&#10;                }&#10;            }&#10;&#10;            return ResponseEntity.ok(result);&#10;        } catch (Exception e) {&#10;            return ResponseEntity.status(500).body(Map.of(&quot;error&quot;, &quot;Lỗi: &quot; + e.getClass().getSimpleName() + &quot; - &quot; + e.getMessage()));&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Xác nhận giao xe cho khách hàng&#10;     * Điều kiện: stationId của hợp đồng phải = stationId của staff&#10;     *&#10;     * Cập nhật RentalRecord:&#10;     * - status = &quot;DELIVERED&quot;&#10;     * - paymentStatus = &quot;PAID&quot; (nếu hiện tại là &quot;PAY_AT_STATION&quot;)&#10;     * - returnNotes từ ghi chú nhân viên&#10;     *&#10;     * Cập nhật Vehicle:&#10;     * - bookingStatus = &quot;RENTED&quot; (xe đã được giao cho khách)&#10;     * - available = false&#10;     */&#10;    @PostMapping(&quot;/{rentalId}/confirm&quot;)&#10;    public ResponseEntity&lt;?&gt; confirmDelivery(&#10;            @PathVariable(&quot;rentalId&quot;) String rentalId,&#10;            HttpServletRequest request&#10;    ) {&#10;        System.out.println(&quot;\n=== START confirmDelivery ===&quot;);&#10;        System.out.println(&quot;rentalId: &quot; + rentalId);&#10;&#10;        try {&#10;            // Lấy returnNotes từ query parameter&#10;            String returnNotes = request.getParameter(&quot;returnNotes&quot;);&#10;            System.out.println(&quot;returnNotes: &quot; + returnNotes);&#10;&#10;            // Step 1: Get rental&#10;            System.out.println(&quot;Step 1: Looking for RentalRecord ID=&quot; + rentalId);&#10;            Optional&lt;RentalRecord&gt; opt = rentalRecordRepository.findById(rentalId);&#10;&#10;            if (!opt.isPresent()) {&#10;                System.out.println(&quot;ERROR: RentalRecord not found!&quot;);&#10;                return ResponseEntity.status(404).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy đơn thuê&quot;));&#10;            }&#10;&#10;            RentalRecord record = opt.get();&#10;            System.out.println(&quot;Step 2: RentalRecord found. Current status=&quot; + record.getStatus());&#10;&#10;            // Step 2: Update status&#10;            System.out.println(&quot;Step 3: Updating status to DELIVERED&quot;);&#10;            record.setStatus(&quot;DELIVERED&quot;);&#10;&#10;            // Step 3: Update payment status if needed&#10;            if (&quot;PAY_AT_STATION&quot;.equals(record.getPaymentStatus())) {&#10;                System.out.println(&quot;Step 4: Updating paymentStatus to PAID&quot;);&#10;                record.setPaymentStatus(&quot;PAID&quot;);&#10;            }&#10;&#10;            // Step 4: Add return notes if provided&#10;            if (returnNotes != null &amp;&amp; !returnNotes.isEmpty()) {&#10;                System.out.println(&quot;Step 5: Adding returnNotes&quot;);&#10;                record.setReturnNotes(returnNotes);&#10;            }&#10;&#10;            // Step 5: Save&#10;            System.out.println(&quot;Step 6: Saving RentalRecord&quot;);&#10;            rentalRecordRepository.save(record);&#10;            System.out.println(&quot;SUCCESS: RentalRecord saved!&quot;);&#10;&#10;            // Step 6: Update vehicle status&#10;            System.out.println(&quot;Step 7: Updating Vehicle&quot;);&#10;            Vehicle vehicle = vehicleRepository.findById(record.getVehicleId()).orElse(null);&#10;            if (vehicle != null) {&#10;                vehicle.setBookingStatus(&quot;RENTED&quot;);&#10;                vehicle.setAvailable(false);&#10;                vehicle.setPendingRentalId(null);&#10;                vehicleRepository.save(vehicle);&#10;                System.out.println(&quot;Vehicle saved successfully&quot;);&#10;            } else {&#10;                System.out.println(&quot;WARNING: Vehicle not found ID=&quot; + record.getVehicleId());&#10;            }&#10;&#10;            System.out.println(&quot;=== END confirmDelivery - SUCCESS ===\n&quot;);&#10;            return ResponseEntity.ok(Map.of(&#10;                &quot;message&quot;, &quot;Giao xe thành công&quot;,&#10;                &quot;rentalId&quot;, rentalId,&#10;                &quot;rentalStatus&quot;, &quot;DELIVERED&quot;,&#10;                &quot;paymentStatus&quot;, record.getPaymentStatus(),&#10;                &quot;vehicleStatus&quot;, &quot;RENTED&quot;&#10;            ));&#10;&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;\n=== ERROR confirmDelivery ===&quot;);&#10;            System.err.println(&quot;Exception: &quot; + e.getClass().getSimpleName());&#10;            System.err.println(&quot;Message: &quot; + e.getMessage());&#10;            e.printStackTrace();&#10;            System.err.println(&quot;=== END ERROR ===\n&quot;);&#10;&#10;            return ResponseEntity.status(500).body(Map.of(&#10;                &quot;error&quot;, &quot;Lỗi: &quot; + e.getMessage()&#10;            ));&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Lấy thông tin chi tiết một đơn thuê để giao xe&#10;     * Điều kiện: stationId của hợp đồng phải = stationId của staff&#10;     */&#10;    @GetMapping(&quot;/{rentalId}&quot;)&#10;    public ResponseEntity&lt;?&gt; getDeliveryDetails(@PathVariable(&quot;rentalId&quot;) String rentalId) {&#10;        try {&#10;            // Lấy thông tin staff hiện tại&#10;            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#10;&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Chưa xác thực. Vui lòng đăng nhập lại.&quot;));&#10;            }&#10;&#10;            String username = null;&#10;            Object principal = authentication.getPrincipal();&#10;&#10;            // Handle different types of principal&#10;            if (principal instanceof String) {&#10;                username = (String) principal;&#10;            } else if (principal instanceof UserDetails) {&#10;                username = ((UserDetails) principal).getUsername();&#10;            } else if (principal != null) {&#10;                username = principal.toString();&#10;            }&#10;&#10;            if (username == null || username.isEmpty() || &quot;anonymousUser&quot;.equals(username)) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy thông tin đăng nhập. Username: &quot; + username));&#10;            }&#10;&#10;            Staff staff = staffRepository.findByUsername(username);&#10;            if (staff == null) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy thông tin nhân viên trong database. Username: &quot; + username));&#10;            }&#10;&#10;            Optional&lt;RentalRecord&gt; optionalRecord = rentalRecordRepository.findById(rentalId);&#10;            if (!optionalRecord.isPresent()) {&#10;                return ResponseEntity.status(404).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy đơn thuê&quot;));&#10;            }&#10;&#10;            RentalRecord record = optionalRecord.get();&#10;&#10;            // Kiểm tra stationId: hợp đồng phải cùng trạm với staff&#10;            if (staff.getStationId() == null || !staff.getStationId().equals(record.getStationId())) {&#10;                return ResponseEntity.status(403).body(Map.of(&quot;error&quot;, &quot;Bạn không có quyền xem đơn thuê này (khác trạm)&quot;));&#10;            }&#10;&#10;            Vehicle vehicle = vehicleRepository.findById(record.getVehicleId()).orElse(null);&#10;&#10;            Map&lt;String, Object&gt; result = new LinkedHashMap&lt;&gt;();&#10;            result.put(&quot;id&quot;, record.getId());&#10;            result.put(&quot;vehiclePlate&quot;, vehicle != null ? vehicle.getPlate() : &quot;&quot;);&#10;            result.put(&quot;vehicleType&quot;, vehicle != null ? vehicle.getType() : &quot;&quot;);&#10;            result.put(&quot;username&quot;, record.getUsername());&#10;            result.put(&quot;startDate&quot;, record.getStartDate());&#10;            result.put(&quot;endDate&quot;, record.getEndDate());&#10;            result.put(&quot;rentalDays&quot;, record.getRentalDays());&#10;            result.put(&quot;total&quot;, record.getTotal());&#10;            result.put(&quot;paymentStatus&quot;, record.getPaymentStatus());&#10;            result.put(&quot;status&quot;, record.getStatus());&#10;            result.put(&quot;returnNotes&quot;, record.getReturnNotes());&#10;&#10;            return ResponseEntity.ok(result);&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;ERROR in getDeliveryDetails: &quot; + e.getMessage());&#10;            e.printStackTrace();&#10;            return ResponseEntity.status(500).body(Map.of(&quot;error&quot;, &quot;Lỗi: &quot; + e.getClass().getSimpleName() + &quot; - &quot; + e.getMessage()));&#10;        }&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package CarRental.example.controller;&#10;&#10;import CarRental.example.document.RentalRecord;&#10;import CarRental.example.document.Vehicle;&#10;import CarRental.example.document.Staff;&#10;import CarRental.example.repository.RentalRecordRepository;&#10;import CarRental.example.repository.VehicleRepository;&#10;import CarRental.example.repository.StaffRepository;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.http.ResponseEntity;&#10;import org.springframework.security.core.Authentication;&#10;import org.springframework.security.core.context.SecurityContextHolder;&#10;import org.springframework.security.core.userdetails.UserDetails;&#10;import org.springframework.web.bind.annotation.*;&#10;import jakarta.servlet.http.HttpServletRequest;&#10;&#10;import java.util.*;&#10;&#10;@RestController&#10;@RequestMapping(&quot;/api/staff/deliver&quot;)&#10;@CrossOrigin(origins = &quot;*&quot;)&#10;public class StaffDeliverController {&#10;&#10;    @Autowired&#10;    private RentalRecordRepository rentalRecordRepository;&#10;&#10;    @Autowired&#10;    private VehicleRepository vehicleRepository;&#10;&#10;    @Autowired&#10;    private StaffRepository staffRepository;&#10;&#10;    /**&#10;     * Lấy danh sách các xe sẵn sàng giao cho khách hàng&#10;     * Điều kiện:&#10;     * - RentalRecord có paymentStatus = &quot;PAID&quot; hoặc &quot;PAY_AT_STATION&quot;&#10;     * - RentalRecord.stationId = Staff.stationId (của staff hiện tại)&#10;     */&#10;    @GetMapping(&quot;/vehicles-ready&quot;)&#10;    public ResponseEntity&lt;?&gt; getVehiclesReadyForDelivery() {&#10;        try {&#10;            // Lấy thông tin staff hiện tại&#10;            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#10;&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Chưa xác thực. Vui lòng đăng nhập lại.&quot;));&#10;            }&#10;&#10;            String username = null;&#10;            Object principal = authentication.getPrincipal();&#10;&#10;            // Handle different types of principal&#10;            if (principal instanceof String) {&#10;                username = (String) principal;&#10;            } else if (principal instanceof UserDetails) {&#10;                username = ((UserDetails) principal).getUsername();&#10;            } else if (principal != null) {&#10;                username = principal.toString();&#10;            }&#10;&#10;            if (username == null || username.isEmpty() || &quot;anonymousUser&quot;.equals(username)) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy thông tin đăng nhập. Username: &quot; + username));&#10;            }&#10;&#10;            Staff staff = staffRepository.findByUsername(username);&#10;&#10;            if (staff == null) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy thông tin nhân viên trong database. Username: &quot; + username));&#10;            }&#10;&#10;            String staffStationId = staff.getStationId();&#10;&#10;            // Lọc RentalRecord:&#10;            // - status = &quot;ACTIVE&quot; (chỉ hiển thị những xe sẵn sàng giao)&#10;            // - paymentStatus = &quot;PAID&quot; hoặc &quot;PAY_AT_STATION&quot;&#10;            // - stationId của hợp đồng = stationId của staff&#10;            List&lt;RentalRecord&gt; readyRecords = rentalRecordRepository.findAll().stream()&#10;                    .filter(record -&gt; &quot;ACTIVE&quot;.equals(record.getStatus()) &amp;&amp;&#10;                                     (&quot;PAID&quot;.equals(record.getPaymentStatus()) ||&#10;                                     &quot;PAY_AT_STATION&quot;.equals(record.getPaymentStatus())) &amp;&amp;&#10;                                     staffStationId.equals(record.getStationId()))&#10;                    .toList();&#10;&#10;            List&lt;Map&lt;String, Object&gt;&gt; result = new ArrayList&lt;&gt;();&#10;&#10;            for (RentalRecord record : readyRecords) {&#10;                Vehicle vehicle = vehicleRepository.findById(record.getVehicleId()).orElse(null);&#10;                if (vehicle != null) {&#10;                    Map&lt;String, Object&gt; item = new LinkedHashMap&lt;&gt;();&#10;                    item.put(&quot;id&quot;, record.getId());&#10;                    item.put(&quot;vehiclePlate&quot;, vehicle.getPlate());&#10;                    item.put(&quot;vehicleType&quot;, vehicle.getType());&#10;                    item.put(&quot;username&quot;, record.getUsername());&#10;                    item.put(&quot;startDate&quot;, record.getStartDate());&#10;                    item.put(&quot;endDate&quot;, record.getEndDate());&#10;                    item.put(&quot;rentalDays&quot;, record.getRentalDays());&#10;                    item.put(&quot;total&quot;, record.getTotal());&#10;                    item.put(&quot;paymentStatus&quot;, record.getPaymentStatus());&#10;                    item.put(&quot;status&quot;, record.getStatus());&#10;                    result.add(item);&#10;                }&#10;            }&#10;&#10;            return ResponseEntity.ok(result);&#10;        } catch (Exception e) {&#10;            return ResponseEntity.status(500).body(Map.of(&quot;error&quot;, &quot;Lỗi: &quot; + e.getClass().getSimpleName() + &quot; - &quot; + e.getMessage()));&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Xác nhận giao xe cho khách hàng&#10;     * Điều kiện: stationId của hợp đồng phải = stationId của staff&#10;     *&#10;     * Cập nhật RentalRecord:&#10;     * - status = &quot;DELIVERED&quot;&#10;     * - paymentStatus = &quot;PAID&quot; (nếu hiện tại là &quot;PAY_AT_STATION&quot;)&#10;     * - returnNotes từ ghi chú nhân viên&#10;     *&#10;     * Cập nhật Vehicle:&#10;     * - bookingStatus = &quot;RENTED&quot; (xe đã được giao cho khách)&#10;     * - available = false&#10;     */&#10;    @PostMapping(&quot;/{rentalId}/confirm&quot;)&#10;    public ResponseEntity&lt;?&gt; confirmDelivery(&#10;            @PathVariable(&quot;rentalId&quot;) String rentalId,&#10;            HttpServletRequest request&#10;    ) {&#10;        System.out.println(&quot;\n=== START confirmDelivery ===&quot;);&#10;        System.out.println(&quot;rentalId: &quot; + rentalId);&#10;&#10;        try {&#10;            // Lấy returnNotes từ query parameter&#10;            String returnNotes = request.getParameter(&quot;returnNotes&quot;);&#10;            System.out.println(&quot;returnNotes: &quot; + returnNotes);&#10;&#10;            // Step 1: Get rental&#10;            System.out.println(&quot;Step 1: Looking for RentalRecord ID=&quot; + rentalId);&#10;            Optional&lt;RentalRecord&gt; opt = rentalRecordRepository.findById(rentalId);&#10;&#10;            if (!opt.isPresent()) {&#10;                System.out.println(&quot;ERROR: RentalRecord not found!&quot;);&#10;                return ResponseEntity.status(404).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy đơn thuê&quot;));&#10;            }&#10;&#10;            RentalRecord record = opt.get();&#10;            System.out.println(&quot;Step 2: RentalRecord found. Current status=&quot; + record.getStatus());&#10;&#10;            // Step 2: Update status&#10;            System.out.println(&quot;Step 3: Updating status to DELIVERED&quot;);&#10;            record.setStatus(&quot;DELIVERED&quot;);&#10;&#10;            // Step 3: Update payment status if needed&#10;            if (&quot;PAY_AT_STATION&quot;.equals(record.getPaymentStatus())) {&#10;                System.out.println(&quot;Step 4: Updating paymentStatus to PAID&quot;);&#10;                record.setPaymentStatus(&quot;PAID&quot;);&#10;            }&#10;&#10;            // Step 4: Add return notes if provided&#10;            if (returnNotes != null &amp;&amp; !returnNotes.isEmpty()) {&#10;                System.out.println(&quot;Step 5: Adding returnNotes&quot;);&#10;                record.setReturnNotes(returnNotes);&#10;            }&#10;&#10;            // Step 5: Save&#10;            System.out.println(&quot;Step 6: Saving RentalRecord&quot;);&#10;            rentalRecordRepository.save(record);&#10;            System.out.println(&quot;SUCCESS: RentalRecord saved!&quot;);&#10;&#10;            // Step 6: Update vehicle status&#10;            System.out.println(&quot;Step 7: Updating Vehicle&quot;);&#10;            Vehicle vehicle = vehicleRepository.findById(record.getVehicleId()).orElse(null);&#10;            if (vehicle != null) {&#10;                vehicle.setBookingStatus(&quot;RENTED&quot;);&#10;                vehicle.setAvailable(false);&#10;                vehicle.setPendingRentalId(null);&#10;                vehicleRepository.save(vehicle);&#10;                System.out.println(&quot;Vehicle saved successfully&quot;);&#10;            } else {&#10;                System.out.println(&quot;WARNING: Vehicle not found ID=&quot; + record.getVehicleId());&#10;            }&#10;&#10;            System.out.println(&quot;=== END confirmDelivery - SUCCESS ===\n&quot;);&#10;            return ResponseEntity.ok(Map.of(&#10;                &quot;message&quot;, &quot;Giao xe thành công&quot;,&#10;                &quot;rentalId&quot;, rentalId,&#10;                &quot;rentalStatus&quot;, &quot;DELIVERED&quot;,&#10;                &quot;paymentStatus&quot;, record.getPaymentStatus(),&#10;                &quot;vehicleStatus&quot;, &quot;RENTED&quot;&#10;            ));&#10;&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;\n=== ERROR confirmDelivery ===&quot;);&#10;            System.err.println(&quot;Exception: &quot; + e.getClass().getSimpleName());&#10;            System.err.println(&quot;Message: &quot; + e.getMessage());&#10;            e.printStackTrace();&#10;            System.err.println(&quot;=== END ERROR ===\n&quot;);&#10;&#10;            return ResponseEntity.status(500).body(Map.of(&#10;                &quot;error&quot;, &quot;Lỗi: &quot; + e.getMessage()&#10;            ));&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Lấy thông tin chi tiết một đơn thuê để giao xe&#10;     * Điều kiện: stationId của hợp đồng phải = stationId của staff&#10;     */&#10;    @GetMapping(&quot;/{rentalId}&quot;)&#10;    public ResponseEntity&lt;?&gt; getDeliveryDetails(@PathVariable(&quot;rentalId&quot;) String rentalId) {&#10;        try {&#10;            // Lấy thông tin staff hiện tại&#10;            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#10;&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Chưa xác thực. Vui lòng đăng nhập lại.&quot;));&#10;            }&#10;&#10;            String username = null;&#10;            Object principal = authentication.getPrincipal();&#10;&#10;            // Handle different types of principal&#10;            if (principal instanceof String) {&#10;                username = (String) principal;&#10;            } else if (principal instanceof UserDetails) {&#10;                username = ((UserDetails) principal).getUsername();&#10;            } else if (principal != null) {&#10;                username = principal.toString();&#10;            }&#10;&#10;            if (username == null || username.isEmpty() || &quot;anonymousUser&quot;.equals(username)) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy thông tin đăng nhập. Username: &quot; + username));&#10;            }&#10;&#10;            Staff staff = staffRepository.findByUsername(username);&#10;            if (staff == null) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy thông tin nhân viên trong database. Username: &quot; + username));&#10;            }&#10;&#10;            Optional&lt;RentalRecord&gt; optionalRecord = rentalRecordRepository.findById(rentalId);&#10;            if (!optionalRecord.isPresent()) {&#10;                return ResponseEntity.status(404).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy đơn thuê&quot;));&#10;            }&#10;&#10;            RentalRecord record = optionalRecord.get();&#10;&#10;            // Kiểm tra stationId: hợp đồng phải cùng trạm với staff&#10;            if (staff.getStationId() == null || !staff.getStationId().equals(record.getStationId())) {&#10;                return ResponseEntity.status(403).body(Map.of(&quot;error&quot;, &quot;Bạn không có quyền xem đơn thuê này (khác trạm)&quot;));&#10;            }&#10;&#10;            Vehicle vehicle = vehicleRepository.findById(record.getVehicleId()).orElse(null);&#10;&#10;            Map&lt;String, Object&gt; result = new LinkedHashMap&lt;&gt;();&#10;            result.put(&quot;id&quot;, record.getId());&#10;            result.put(&quot;vehiclePlate&quot;, vehicle != null ? vehicle.getPlate() : &quot;&quot;);&#10;            result.put(&quot;vehicleType&quot;, vehicle != null ? vehicle.getType() : &quot;&quot;);&#10;            result.put(&quot;username&quot;, record.getUsername());&#10;            result.put(&quot;startDate&quot;, record.getStartDate());&#10;            result.put(&quot;endDate&quot;, record.getEndDate());&#10;            result.put(&quot;rentalDays&quot;, record.getRentalDays());&#10;            result.put(&quot;total&quot;, record.getTotal());&#10;            result.put(&quot;paymentStatus&quot;, record.getPaymentStatus());&#10;            result.put(&quot;status&quot;, record.getStatus());&#10;            result.put(&quot;returnNotes&quot;, record.getReturnNotes());&#10;&#10;            return ResponseEntity.ok(result);&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;ERROR in getDeliveryDetails: &quot; + e.getMessage());&#10;            e.printStackTrace();&#10;            return ResponseEntity.status(500).body(Map.of(&quot;error&quot;, &quot;Lỗi: &quot; + e.getClass().getSimpleName() + &quot; - &quot; + e.getMessage()));&#10;        }&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/src/main/java/controller/StaffReturnController.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/controller/StaffReturnController.java" />
              <option name="updatedContent" value="package CarRental.example.controller;&#10;&#10;import CarRental.example.document.RentalRecord;&#10;import CarRental.example.document.Vehicle;&#10;import CarRental.example.document.Staff;&#10;import CarRental.example.repository.RentalRecordRepository;&#10;import CarRental.example.repository.VehicleRepository;&#10;import CarRental.example.repository.StaffRepository;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.http.ResponseEntity;&#10;import org.springframework.security.core.Authentication;&#10;import org.springframework.security.core.context.SecurityContextHolder;&#10;import org.springframework.security.core.userdetails.UserDetails;&#10;import org.springframework.web.bind.annotation.*;&#10;import jakarta.servlet.http.HttpServletRequest;&#10;&#10;import java.util.*;&#10;&#10;@RestController&#10;@RequestMapping(&quot;/api/staff/return&quot;)&#10;@CrossOrigin(origins = &quot;*&quot;)&#10;public class StaffReturnController {&#10;&#10;    @Autowired&#10;    private RentalRecordRepository rentalRecordRepository;&#10;&#10;    @Autowired&#10;    private VehicleRepository vehicleRepository;&#10;&#10;    @Autowired&#10;    private StaffRepository staffRepository;&#10;&#10;    /**&#10;     * Lấy danh sách các xe sẵn sàng trả từ khách hàng&#10;     * Điều kiện:&#10;     * - RentalRecord có status = &quot;DELIVERED&quot;&#10;     * - RentalRecord.stationId = Staff.stationId (của staff hiện tại)&#10;     */&#10;    @GetMapping(&quot;/vehicles-ready&quot;)&#10;    public ResponseEntity&lt;?&gt; getVehiclesReadyForReturn() {&#10;        try {&#10;            // Lấy thông tin staff hiện tại&#10;            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#10;&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Chưa xác thực. Vui lòng đăng nhập lại.&quot;));&#10;            }&#10;&#10;            String username = null;&#10;            Object principal = authentication.getPrincipal();&#10;&#10;            // Handle different types of principal&#10;            if (principal instanceof String) {&#10;                username = (String) principal;&#10;            } else if (principal instanceof UserDetails) {&#10;                username = ((UserDetails) principal).getUsername();&#10;            } else if (principal != null) {&#10;                username = principal.toString();&#10;            }&#10;&#10;            if (username == null || username.isEmpty() || &quot;anonymousUser&quot;.equals(username)) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy thông tin đăng nhập. Username: &quot; + username));&#10;            }&#10;&#10;            Staff staff = staffRepository.findByUsername(username);&#10;&#10;            if (staff == null) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy thông tin nhân viên trong database. Username: &quot; + username));&#10;            }&#10;&#10;            String staffStationId = staff.getStationId();&#10;&#10;            // Lọc RentalRecord:&#10;            // - status = &quot;DELIVERED&quot; (xe đã được giao cho khách, giờ sẵn sàng trả)&#10;            // - stationId của hợp đồng = stationId của staff&#10;            List&lt;RentalRecord&gt; readyRecords = rentalRecordRepository.findAll().stream()&#10;                    .filter(record -&gt; &quot;DELIVERED&quot;.equals(record.getStatus()) &amp;&amp;&#10;                                     staffStationId.equals(record.getStationId()))&#10;                    .toList();&#10;&#10;            List&lt;Map&lt;String, Object&gt;&gt; result = new ArrayList&lt;&gt;();&#10;&#10;            for (RentalRecord record : readyRecords) {&#10;                Vehicle vehicle = vehicleRepository.findById(record.getVehicleId()).orElse(null);&#10;                if (vehicle != null) {&#10;                    Map&lt;String, Object&gt; item = new LinkedHashMap&lt;&gt;();&#10;                    item.put(&quot;id&quot;, record.getId());&#10;                    item.put(&quot;vehiclePlate&quot;, vehicle.getPlate());&#10;                    item.put(&quot;vehicleType&quot;, vehicle.getType());&#10;                    item.put(&quot;username&quot;, record.getUsername());&#10;                    item.put(&quot;startDate&quot;, record.getStartDate());&#10;                    item.put(&quot;endDate&quot;, record.getEndDate());&#10;                    item.put(&quot;rentalDays&quot;, record.getRentalDays());&#10;                    item.put(&quot;total&quot;, record.getTotal());&#10;                    item.put(&quot;paymentStatus&quot;, record.getPaymentStatus());&#10;                    item.put(&quot;status&quot;, record.getStatus());&#10;                    result.add(item);&#10;                }&#10;            }&#10;&#10;            return ResponseEntity.ok(result);&#10;        } catch (Exception e) {&#10;            return ResponseEntity.status(500).body(Map.of(&quot;error&quot;, &quot;Lỗi: &quot; + e.getClass().getSimpleName() + &quot; - &quot; + e.getMessage()));&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Xác nhận trả xe từ khách hàng&#10;     * Điều kiện: stationId của hợp đồng phải = stationId của staff&#10;     *&#10;     * Cập nhật RentalRecord:&#10;     * - status = &quot;COMPLETED&quot;&#10;     * - damageFee (từ tham số)&#10;     * - returnNote (ghi chú trả xe)&#10;     * - total được cộng thêm damageFee&#10;     *&#10;     * Cập nhật Vehicle:&#10;     * - available = true (xe trở lại trạm)&#10;     * - bookingStatus = &quot;AVAILABLE&quot; (xe có sẵn để thuê)&#10;     */&#10;    @PostMapping(&quot;/{rentalId}/confirm&quot;)&#10;    public ResponseEntity&lt;?&gt; confirmReturn(&#10;            @PathVariable(&quot;rentalId&quot;) String rentalId,&#10;            HttpServletRequest request&#10;    ) {&#10;        try {&#10;            // Lấy damageFee và returnNote từ query parameters&#10;            String damageFeeStr = request.getParameter(&quot;damageFee&quot;);&#10;            String returnNote = request.getParameter(&quot;returnNote&quot;);&#10;            &#10;            double damageFee = 0;&#10;            if (damageFeeStr != null &amp;&amp; !damageFeeStr.isEmpty()) {&#10;                damageFee = Double.parseDouble(damageFeeStr);&#10;            }&#10;&#10;            // Step 1: Get rental&#10;            Optional&lt;RentalRecord&gt; opt = rentalRecordRepository.findById(rentalId);&#10;&#10;            if (opt.isEmpty()) {&#10;                return ResponseEntity.status(404).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy đơn thuê&quot;));&#10;            }&#10;&#10;            RentalRecord record = opt.get();&#10;&#10;            // Step 2: Update status to COMPLETED&#10;            record.setStatus(&quot;COMPLETED&quot;);&#10;&#10;            // Step 3: Add damage fee&#10;            if (damageFee &gt; 0) {&#10;                record.setDamageFee(damageFee);&#10;                record.setTotal(record.getTotal() + damageFee);&#10;            }&#10;&#10;            // Step 4: Add return notes if provided&#10;            if (returnNote != null &amp;&amp; !returnNote.isEmpty()) {&#10;                record.setReturnNotes(returnNote);&#10;            }&#10;&#10;            // Step 5: Save&#10;            rentalRecordRepository.save(record);&#10;&#10;            // Step 6: Update vehicle status - xe trả về trạm&#10;            Vehicle vehicle = vehicleRepository.findById(record.getVehicleId()).orElse(null);&#10;            if (vehicle != null) {&#10;                vehicle.setAvailable(true);&#10;                vehicle.setBookingStatus(&quot;AVAILABLE&quot;);&#10;                vehicle.setPendingRentalId(null);&#10;                vehicleRepository.save(vehicle);&#10;            }&#10;&#10;            return ResponseEntity.ok(Map.of(&#10;                &quot;message&quot;, &quot;Trả xe thành công&quot;,&#10;                &quot;rentalId&quot;, rentalId,&#10;                &quot;rentalStatus&quot;, &quot;COMPLETED&quot;,&#10;                &quot;paymentStatus&quot;, record.getPaymentStatus(),&#10;                &quot;vehicleStatus&quot;, &quot;AVAILABLE&quot;&#10;            ));&#10;&#10;        } catch (NumberFormatException e) {&#10;            return ResponseEntity.status(400).body(Map.of(&quot;error&quot;, &quot;Phí hư hỏng không hợp lệ: &quot; + e.getMessage()));&#10;        } catch (Exception e) {&#10;            return ResponseEntity.status(500).body(Map.of(&quot;error&quot;, &quot;Lỗi: &quot; + e.getMessage()));&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Lấy thông tin chi tiết một đơn thuê để trả xe&#10;     * Điều kiện: stationId của hợp đồng phải = stationId của staff&#10;     */&#10;    @GetMapping(&quot;/{rentalId}&quot;)&#10;    public ResponseEntity&lt;?&gt; getReturnDetails(@PathVariable(&quot;rentalId&quot;) String rentalId) {&#10;        try {&#10;            // Lấy thông tin staff hiện tại&#10;            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();&#10;&#10;            if (authentication == null || !authentication.isAuthenticated()) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Chưa xác thực. Vui lòng đăng nhập lại.&quot;));&#10;            }&#10;&#10;            String username = null;&#10;            Object principal = authentication.getPrincipal();&#10;&#10;            // Handle different types of principal&#10;            if (principal instanceof String) {&#10;                username = (String) principal;&#10;            } else if (principal instanceof UserDetails) {&#10;                username = ((UserDetails) principal).getUsername();&#10;            } else if (principal != null) {&#10;                username = principal.toString();&#10;            }&#10;&#10;            if (username == null || username.isEmpty() || &quot;anonymousUser&quot;.equals(username)) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy thông tin đăng nhập. Username: &quot; + username));&#10;            }&#10;&#10;            Staff staff = staffRepository.findByUsername(username);&#10;            if (staff == null) {&#10;                return ResponseEntity.status(401).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy thông tin nhân viên trong database. Username: &quot; + username));&#10;            }&#10;&#10;            Optional&lt;RentalRecord&gt; optionalRecord = rentalRecordRepository.findById(rentalId);&#10;            if (optionalRecord.isEmpty()) {&#10;                return ResponseEntity.status(404).body(Map.of(&quot;error&quot;, &quot;Không tìm thấy đơn thuê&quot;));&#10;            }&#10;&#10;            RentalRecord record = optionalRecord.get();&#10;&#10;            // Kiểm tra stationId: hợp đồng phải cùng trạm với staff&#10;            if (staff.getStationId() == null || !staff.getStationId().equals(record.getStationId())) {&#10;                return ResponseEntity.status(403).body(Map.of(&quot;error&quot;, &quot;Bạn không có quyền xem đơn thuê này (khác trạm)&quot;));&#10;            }&#10;&#10;            Vehicle vehicle = vehicleRepository.findById(record.getVehicleId()).orElse(null);&#10;&#10;            Map&lt;String, Object&gt; result = new LinkedHashMap&lt;&gt;();&#10;            result.put(&quot;id&quot;, record.getId());&#10;            result.put(&quot;vehiclePlate&quot;, vehicle != null ? vehicle.getPlate() : &quot;&quot;);&#10;            result.put(&quot;vehicleType&quot;, vehicle != null ? vehicle.getType() : &quot;&quot;);&#10;            result.put(&quot;username&quot;, record.getUsername());&#10;            result.put(&quot;startDate&quot;, record.getStartDate());&#10;            result.put(&quot;endDate&quot;, record.getEndDate());&#10;            result.put(&quot;rentalDays&quot;, record.getRentalDays());&#10;            result.put(&quot;total&quot;, record.getTotal());&#10;            result.put(&quot;paymentStatus&quot;, record.getPaymentStatus());&#10;            result.put(&quot;status&quot;, record.getStatus());&#10;            result.put(&quot;returnNotes&quot;, record.getReturnNotes());&#10;&#10;            return ResponseEntity.ok(result);&#10;        } catch (Exception e) {&#10;            return ResponseEntity.status(500).body(Map.of(&quot;error&quot;, &quot;Lỗi: &quot; + e.getClass().getSimpleName() + &quot; - &quot; + e.getMessage()));&#10;        }&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/src/main/resources/static/js/staff-return-vehicle.js">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/resources/static/js/staff-return-vehicle.js" />
              <option name="originalContent" value="// ========== STAFF RETURN VEHICLE PAGE SCRIPT ==========&#10;&#10;// Lưu thông tin rental hiện tại&#10;let currentRentalId = null;&#10;&#10;// Tải danh sách xe sẵn sàng trả khi trang load&#10;document.addEventListener('DOMContentLoaded', function() {&#10;    loadReturnVehicles();&#10;});&#10;&#10;/**&#10; * Lấy danh sách các xe sẵn sàng trả từ API&#10; * Điều kiện: status = &quot;DELIVERED&quot; (xe đã được giao cho khách)&#10; */&#10;function loadReturnVehicles() {&#10;    fetch('/api/staff/return/vehicles-ready')&#10;        .then(response =&gt; response.json())&#10;        .then(data =&gt; {&#10;            populateReturnTable(data);&#10;        })&#10;        .catch(error =&gt; {&#10;            console.error('Lỗi khi tải danh sách xe:', error);&#10;            alert('Lỗi khi tải danh sách xe sẵn sàng trả');&#10;        });&#10;}&#10;&#10;/**&#10; * Điền dữ liệu vào bảng danh sách trả xe&#10; * Hiển thị: Biển số xe, Loại xe, Tên người thuê, Ngày thuê, Trạng thái thanh toán&#10; */&#10;function populateReturnTable(rentalRecords) {&#10;    const tableBody = document.getElementById('returnTableBody');&#10;    tableBody.innerHTML = '';&#10;&#10;    if (!rentalRecords || rentalRecords.length === 0) {&#10;        tableBody.innerHTML = '&lt;tr&gt;&lt;td colspan=&quot;6&quot; style=&quot;text-align: center; padding: 20px; color: #999;&quot;&gt;Không có đơn hàng sẵn sàng trả&lt;/td&gt;&lt;/tr&gt;';&#10;        return;&#10;    }&#10;&#10;    rentalRecords.forEach((rental, index) =&gt; {&#10;        const row = document.createElement('tr');&#10;&#10;        // Xác định trạng thái thanh toán và màu badge&#10;        let paymentStatusBadge = '';&#10;        const paymentStatus = rental.paymentStatus || 'UNKNOWN';&#10;&#10;        if (paymentStatus === 'PAID') {&#10;            paymentStatusBadge = '&lt;span class=&quot;status-badge status-paid&quot;&gt;ĐÃ THANH TOÁN&lt;/span&gt;';&#10;        } else if (paymentStatus === 'PAY_AT_STATION') {&#10;            paymentStatusBadge = '&lt;span class=&quot;status-badge status-pending&quot;&gt;THANH TOÁN TẠI TRẠM&lt;/span&gt;';&#10;        } else {&#10;            paymentStatusBadge = '&lt;span class=&quot;status-badge status-pending&quot;&gt;CHƯA THANH TOÁN&lt;/span&gt;';&#10;        }&#10;&#10;        // Format ngày từ startDate (LocalDate từ RentalRecord)&#10;        const rentalDate = rental.startDate ? formatDate(rental.startDate) : 'N/A';&#10;        const vehiclePlate = rental.vehiclePlate || 'N/A';&#10;        const vehicleType = rental.vehicleType || 'N/A';&#10;        const customerName = rental.username || 'N/A';&#10;&#10;        row.innerHTML = `&#10;            &lt;td class=&quot;plate-cell&quot;&gt;${vehiclePlate}&lt;/td&gt;&#10;            &lt;td&gt;${vehicleType}&lt;/td&gt;&#10;            &lt;td&gt;${customerName}&lt;/td&gt;&#10;            &lt;td&gt;${rentalDate}&lt;/td&gt;&#10;            &lt;td&gt;${paymentStatusBadge}&lt;/td&gt;&#10;            &lt;td class=&quot;action-cell&quot;&gt;&#10;                &lt;button class=&quot;btn-action btn-deliver-now&quot; onclick=&quot;handleReturnVehicle('${rental.id}', '${vehiclePlate}', '${customerName}')&quot;&gt;&#10;                    &lt;span class=&quot;icon&quot;&gt;↩️&lt;/span&gt;&#10;                &lt;/button&gt;&#10;            &lt;/td&gt;&#10;        `;&#10;&#10;        tableBody.appendChild(row);&#10;    });&#10;}&#10;&#10;/**&#10; * Format ngày từ định dạng ISO hoặc đối tượng Date&#10; * Chuyển đổi &quot;2025-11-22&quot; thành &quot;22/11/2025&quot;&#10; */&#10;function formatDate(dateStr) {&#10;    if (!dateStr) return 'N/A';&#10;&#10;    let date;&#10;    if (typeof dateStr === 'string') {&#10;        date = new Date(dateStr);&#10;    } else {&#10;        date = new Date(dateStr);&#10;    }&#10;&#10;    if (isNaN(date)) return 'N/A';&#10;&#10;    const day = String(date.getDate()).padStart(2, '0');&#10;    const month = String(date.getMonth() + 1).padStart(2, '0');&#10;    const year = date.getFullYear();&#10;&#10;    return `${day}/${month}/${year}`;&#10;}&#10;&#10;/**&#10; * Format tiền tệ thành định dạng VND&#10; * Ví dụ: 450000 → &quot;450,000 VND&quot;&#10; */&#10;function formatCurrency(value) {&#10;    if (!value) return 'N/A';&#10;    return new Intl.NumberFormat('vi-VN', {&#10;        style: 'currency',&#10;        currency: 'VND'&#10;    }).format(value);&#10;}&#10;&#10;/**&#10; * Format trạng thái thanh toán&#10; * &quot;PAID&quot; → &quot;Đã thanh toán&quot;&#10; * &quot;PAY_AT_STATION&quot; → &quot;Thanh toán tại trạm&quot;&#10; */&#10;function formatPaymentStatus(status) {&#10;    if (!status) return 'N/A';&#10;    const statusMap = {&#10;        'PAID': 'Đã thanh toán',&#10;        'PAY_AT_STATION': 'Thanh toán tại trạm',&#10;        'PENDING': 'Chờ thanh toán',&#10;        'UNPAID': 'Chưa thanh toán'&#10;    };&#10;    return statusMap[status] || status;&#10;}&#10;&#10;/**&#10; * Mở modal trả xe với toàn bộ thông tin chi tiết&#10; */&#10;function handleReturnVehicle(rentalId, plate, customerName) {&#10;    currentRentalId = rentalId;&#10;&#10;    // Gọi API để lấy chi tiết hợp đồng&#10;    fetch(`/api/staff/return/${rentalId}`)&#10;        .then(response =&gt; response.json())&#10;        .then(data =&gt; {&#10;            // Điền thông tin xe&#10;            document.getElementById('returnPlate').value = data.vehiclePlate || plate;&#10;            document.getElementById('returnVehicleType').value = data.vehicleType || 'N/A';&#10;&#10;            // Điền thông tin khách hàng&#10;            document.getElementById('returnCustomer').value = data.username || customerName;&#10;&#10;            // Điền thông tin thuê xe&#10;            document.getElementById('returnStartDate').value = formatDate(data.startDate) || 'N/A';&#10;            document.getElementById('returnEndDate').value = formatDate(data.endDate) || 'N/A';&#10;            document.getElementById('returnRentalDays').value = (data.rentalDays || 0) + ' ngày';&#10;&#10;            // Điền thông tin thanh toán&#10;            document.getElementById('returnTotal').value = formatCurrency(data.total) || 'N/A';&#10;            document.getElementById('returnPaymentStatus').value = formatPaymentStatus(data.paymentStatus) || 'N/A';&#10;&#10;            // Làm trống phí hư hỏng và ghi chú&#10;            document.getElementById('returnDamageFee').value = '';&#10;            document.getElementById('returnNote').value = '';&#10;&#10;            // Mở modal&#10;            document.getElementById('returnModal').style.display = 'block';&#10;        })&#10;        .catch(error =&gt; {&#10;            console.error('Lỗi khi lấy chi tiết hợp đồng:', error);&#10;            alert('Lỗi khi lấy thông tin chi tiết');&#10;        });&#10;}&#10;&#10;/**&#10; * Đóng modal trả xe&#10; */&#10;function closeReturnModal() {&#10;    document.getElementById('returnModal').style.display = 'none';&#10;    currentRentalId = null;&#10;}&#10;&#10;/**&#10; * Xác nhận trả xe&#10; * Gửi POST request với damageFee và returnNote&#10; */&#10;function confirmReturn() {&#10;    if (!currentRentalId) {&#10;        alert('Lỗi: Không tìm thấy thông tin đơn thuê');&#10;        return;&#10;    }&#10;&#10;    const damageFee = document.getElementById('returnDamageFee').value || 0;&#10;    const note = document.getElementById('returnNote').value;&#10;&#10;    // Xây dựng URL với tham số damageFee và returnNote&#10;    let url = `/api/staff/return/${currentRentalId}/confirm?damageFee=${damageFee}`;&#10;    if (note &amp;&amp; note.trim()) {&#10;        url += `&amp;returnNote=${encodeURIComponent(note)}`;&#10;    }&#10;&#10;    fetch(url, {&#10;        method: 'POST',&#10;        headers: {&#10;            'Content-Type': 'application/json'&#10;        }&#10;    })&#10;    .then(response =&gt; {&#10;        console.log('Response status:', response.status);&#10;        console.log('Response headers:', response.headers);&#10;&#10;        if (!response.ok) {&#10;            return response.json().then(data =&gt; {&#10;                throw new Error(data.error || `HTTP error! status: ${response.status}`);&#10;            });&#10;        }&#10;        return response.json();&#10;    })&#10;    .then(data =&gt; {&#10;        console.log('Success data:', data);&#10;&#10;        if (data.error) {&#10;            alert('Lỗi: ' + data.error);&#10;        } else {&#10;            // ✅ Hiển thị chi tiết trả xe thành công&#10;            const successMsg = `✓ Xe đã được trả thành công!\n\n` +&#10;                `Trạng thái đơn: ${data.rentalStatus || 'COMPLETED'}\n` +&#10;                `Trạng thái thanh toán: ${formatPaymentStatus(data.paymentStatus) || 'N/A'}\n` +&#10;                `Trạng thái xe: ${data.vehicleStatus || 'AVAILABLE'}`;&#10;&#10;            alert(successMsg);&#10;            closeReturnModal();&#10;            // Tải lại danh sách&#10;            loadReturnVehicles();&#10;        }&#10;    })&#10;    .catch(error =&gt; {&#10;        console.error('Lỗi khi trả xe:', error);&#10;        console.error('Error message:', error.message);&#10;        alert('Lỗi khi trả xe: ' + error.message);&#10;    });&#10;}&#10;&#10;/**&#10; * Đóng modal khi click bên ngoài&#10; */&#10;window.onclick = function(event) {&#10;    const modal = document.getElementById('returnModal');&#10;    if (event.target == modal) {&#10;        modal.style.display = 'none';&#10;    }&#10;}&#10;&#10;/**&#10; * Tìm kiếm theo biển số xe (thời gian thực)&#10; */&#10;document.addEventListener('DOMContentLoaded', function() {&#10;    const searchPlateInput = document.getElementById('searchPlate');&#10;    if (searchPlateInput) {&#10;        searchPlateInput.addEventListener('keyup', function() {&#10;            filterTable();&#10;        });&#10;    }&#10;});&#10;&#10;/**&#10; * Tìm kiếm theo tên khách hàng (thời gian thực)&#10; */&#10;document.addEventListener('DOMContentLoaded', function() {&#10;    const searchCustomerInput = document.getElementById('searchCustomer');&#10;    if (searchCustomerInput) {&#10;        searchCustomerInput.addEventListener('keyup', function() {&#10;            filterTable();&#10;        });&#10;    }&#10;});&#10;&#10;/**&#10; * Hàm lọc bảng theo cả hai tiêu chí: biển số và tên khách hàng&#10; * Sử dụng logic AND - cả hai điều kiện phải match&#10; */&#10;function filterTable() {&#10;    const searchPlate = document.getElementById('searchPlate').value.toLowerCase();&#10;    const searchCustomer = document.getElementById('searchCustomer').value.toLowerCase();&#10;    const tableBody = document.getElementById('returnTableBody');&#10;    const rows = tableBody.getElementsByTagName('tr');&#10;&#10;    for (let row of rows) {&#10;        const cells = row.querySelectorAll('td');&#10;&#10;        if (cells.length &gt;= 3) {&#10;            // Cột 0: Biển số xe&#10;            const plate = cells[0].textContent.toLowerCase();&#10;            // Cột 2: Tên khách hàng (username từ RentalRecord)&#10;            const customerName = cells[2].textContent.toLowerCase();&#10;&#10;            const matchPlate = plate.includes(searchPlate);&#10;            const matchCustomer = customerName.includes(searchCustomer);&#10;&#10;            // Hiển thị dòng nếu cả hai điều kiện đều match (AND logic)&#10;            // Hoặc chỉ một nếu chỉ có một field được nhập&#10;            if ((searchPlate === '' || matchPlate) &amp;&amp; (searchCustomer === '' || matchCustomer)) {&#10;                row.style.display = '';&#10;            } else {&#10;                row.style.display = 'none';&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="// ========== STAFF RETURN VEHICLE PAGE SCRIPT ==========&#10;&#10;// Lưu thông tin rental hiện tại&#10;let currentRentalId = null;&#10;&#10;// Tải danh sách xe sẵn sàng trả khi trang load&#10;document.addEventListener('DOMContentLoaded', function() {&#10;    loadReturnVehicles();&#10;});&#10;&#10;/**&#10; * Lấy danh sách các xe sẵn sàng trả từ API&#10; * Điều kiện: status = &quot;DELIVERED&quot; (xe đã được giao cho khách)&#10; */&#10;function loadReturnVehicles() {&#10;    fetch('/api/staff/return/vehicles-ready')&#10;        .then(response =&gt; response.json())&#10;        .then(data =&gt; {&#10;            populateReturnTable(data);&#10;        })&#10;        .catch(error =&gt; {&#10;            console.error('Lỗi khi tải danh sách xe:', error);&#10;            alert('Lỗi khi tải danh sách xe sẵn sàng trả');&#10;        });&#10;}&#10;&#10;/**&#10; * Điền dữ liệu vào bảng danh sách trả xe&#10; * Hiển thị: Biển số xe, Loại xe, Tên người thuê, Ngày thuê, Trạng thái thanh toán&#10; */&#10;function populateReturnTable(rentalRecords) {&#10;    const tableBody = document.getElementById('returnTableBody');&#10;    tableBody.innerHTML = '';&#10;&#10;    if (!rentalRecords || rentalRecords.length === 0) {&#10;        tableBody.innerHTML = '&lt;tr&gt;&lt;td colspan=&quot;6&quot; style=&quot;text-align: center; padding: 20px; color: #999;&quot;&gt;Không có đơn hàng sẵn sàng trả&lt;/td&gt;&lt;/tr&gt;';&#10;        return;&#10;    }&#10;&#10;    rentalRecords.forEach((rental, index) =&gt; {&#10;        const row = document.createElement('tr');&#10;&#10;        // Xác định trạng thái thanh toán và màu badge&#10;        let paymentStatusBadge = '';&#10;        const paymentStatus = rental.paymentStatus || 'UNKNOWN';&#10;&#10;        if (paymentStatus === 'PAID') {&#10;            paymentStatusBadge = '&lt;span class=&quot;status-badge status-paid&quot;&gt;ĐÃ THANH TOÁN&lt;/span&gt;';&#10;        } else if (paymentStatus === 'PAY_AT_STATION') {&#10;            paymentStatusBadge = '&lt;span class=&quot;status-badge status-pending&quot;&gt;THANH TOÁN TẠI TRẠM&lt;/span&gt;';&#10;        } else {&#10;            paymentStatusBadge = '&lt;span class=&quot;status-badge status-pending&quot;&gt;CHƯA THANH TOÁN&lt;/span&gt;';&#10;        }&#10;&#10;        // Format ngày từ startDate (LocalDate từ RentalRecord)&#10;        const rentalDate = rental.startDate ? formatDate(rental.startDate) : 'N/A';&#10;        const vehiclePlate = rental.vehiclePlate || 'N/A';&#10;        const vehicleType = rental.vehicleType || 'N/A';&#10;        const customerName = rental.username || 'N/A';&#10;&#10;        row.innerHTML = `&#10;            &lt;td class=&quot;plate-cell&quot;&gt;${vehiclePlate}&lt;/td&gt;&#10;            &lt;td&gt;${vehicleType}&lt;/td&gt;&#10;            &lt;td&gt;${customerName}&lt;/td&gt;&#10;            &lt;td&gt;${rentalDate}&lt;/td&gt;&#10;            &lt;td&gt;${paymentStatusBadge}&lt;/td&gt;&#10;            &lt;td class=&quot;action-cell&quot;&gt;&#10;                &lt;button class=&quot;btn-action btn-deliver-now&quot; onclick=&quot;handleReturnVehicle('${rental.id}', '${vehiclePlate}', '${customerName}')&quot;&gt;&#10;                    &lt;span class=&quot;icon&quot;&gt;↩️&lt;/span&gt;&#10;                &lt;/button&gt;&#10;            &lt;/td&gt;&#10;        `;&#10;&#10;        tableBody.appendChild(row);&#10;    });&#10;}&#10;&#10;/**&#10; * Format ngày từ định dạng ISO hoặc đối tượng Date&#10; * Chuyển đổi &quot;2025-11-22&quot; thành &quot;22/11/2025&quot;&#10; */&#10;function formatDate(dateStr) {&#10;    if (!dateStr) return 'N/A';&#10;&#10;    let date;&#10;    if (typeof dateStr === 'string') {&#10;        date = new Date(dateStr);&#10;    } else {&#10;        date = new Date(dateStr);&#10;    }&#10;&#10;    if (isNaN(date)) return 'N/A';&#10;&#10;    const day = String(date.getDate()).padStart(2, '0');&#10;    const month = String(date.getMonth() + 1).padStart(2, '0');&#10;    const year = date.getFullYear();&#10;&#10;    return `${day}/${month}/${year}`;&#10;}&#10;&#10;/**&#10; * Format tiền tệ thành định dạng VND&#10; * Ví dụ: 450000 → &quot;450,000 VND&quot;&#10; */&#10;function formatCurrency(value) {&#10;    if (!value) return 'N/A';&#10;    return new Intl.NumberFormat('vi-VN', {&#10;        style: 'currency',&#10;        currency: 'VND'&#10;    }).format(value);&#10;}&#10;&#10;/**&#10; * Format trạng thái thanh toán&#10; * &quot;PAID&quot; → &quot;Đã thanh toán&quot;&#10; * &quot;PAY_AT_STATION&quot; → &quot;Thanh toán tại trạm&quot;&#10; */&#10;function formatPaymentStatus(status) {&#10;    if (!status) return 'N/A';&#10;    const statusMap = {&#10;        'PAID': 'Đã thanh toán',&#10;        'PAY_AT_STATION': 'Thanh toán tại trạm',&#10;        'PENDING': 'Chờ thanh toán',&#10;        'UNPAID': 'Chưa thanh toán'&#10;    };&#10;    return statusMap[status] || status;&#10;}&#10;&#10;/**&#10; * Mở modal trả xe với toàn bộ thông tin chi tiết&#10; */&#10;function handleReturnVehicle(rentalId, plate, customerName) {&#10;    currentRentalId = rentalId;&#10;&#10;    // Gọi API để lấy chi tiết hợp đồng&#10;    fetch(`/api/staff/return/${rentalId}`)&#10;        .then(response =&gt; response.json())&#10;        .then(data =&gt; {&#10;            // Điền thông tin xe&#10;            document.getElementById('returnPlate').value = data.vehiclePlate || plate;&#10;            document.getElementById('returnVehicleType').value = data.vehicleType || 'N/A';&#10;&#10;            // Điền thông tin khách hàng&#10;            document.getElementById('returnCustomer').value = data.username || customerName;&#10;&#10;            // Điền thông tin thuê xe&#10;            document.getElementById('returnStartDate').value = formatDate(data.startDate) || 'N/A';&#10;            document.getElementById('returnEndDate').value = formatDate(data.endDate) || 'N/A';&#10;            document.getElementById('returnRentalDays').value = (data.rentalDays || 0) + ' ngày';&#10;&#10;            // Điền thông tin thanh toán&#10;            document.getElementById('returnTotal').value = formatCurrency(data.total) || 'N/A';&#10;            document.getElementById('returnPaymentStatus').value = formatPaymentStatus(data.paymentStatus) || 'N/A';&#10;&#10;            // Làm trống phí hư hỏng và ghi chú&#10;            document.getElementById('returnDamageFee').value = '';&#10;            document.getElementById('returnNote').value = '';&#10;&#10;            // Mở modal&#10;            document.getElementById('returnModal').style.display = 'block';&#10;        })&#10;        .catch(error =&gt; {&#10;            console.error('Lỗi khi lấy chi tiết hợp đồng:', error);&#10;            alert('Lỗi khi lấy thông tin chi tiết');&#10;        });&#10;}&#10;&#10;/**&#10; * Đóng modal trả xe&#10; */&#10;function closeReturnModal() {&#10;    document.getElementById('returnModal').style.display = 'none';&#10;    currentRentalId = null;&#10;}&#10;&#10;/**&#10; * Xác nhận trả xe&#10; * Gửi POST request với damageFee và returnNote&#10; */&#10;function confirmReturn() {&#10;    if (!currentRentalId) {&#10;        alert('Lỗi: Không tìm thấy thông tin đơn thuê');&#10;        return;&#10;    }&#10;&#10;    const damageFee = document.getElementById('returnDamageFee').value || '0';&#10;    const note = document.getElementById('returnNote').value;&#10;&#10;    // Xây dựng URL với tham số damageFee và returnNote&#10;    let url = `/api/staff/return/${currentRentalId}/confirm?damageFee=${damageFee}`;&#10;    if (note &amp;&amp; note.trim()) {&#10;        url += `&amp;returnNote=${encodeURIComponent(note)}`;&#10;    }&#10;&#10;    fetch(url, {&#10;        method: 'POST',&#10;        headers: {&#10;            'Content-Type': 'application/json'&#10;        }&#10;    })&#10;    .then(response =&gt; {&#10;        if (!response.ok) {&#10;            return response.json().then(data =&gt; {&#10;                throw new Error(data.error || `HTTP error! status: ${response.status}`);&#10;            });&#10;        }&#10;        return response.json();&#10;    })&#10;    .then(data =&gt; {&#10;        if (data.error) {&#10;            alert('Lỗi: ' + data.error);&#10;        } else {&#10;            // ✅ Hiển thị chi tiết trả xe thành công&#10;            const successMsg = `✓ Xe đã được trả thành công!\n\n` +&#10;                `Trạng thái đơn: ${data.rentalStatus || 'COMPLETED'}\n` +&#10;                `Trạng thái thanh toán: ${formatPaymentStatus(data.paymentStatus) || 'N/A'}\n` +&#10;                `Trạng thái xe: ${data.vehicleStatus || 'AVAILABLE'}`;&#10;&#10;            alert(successMsg);&#10;            closeReturnModal();&#10;            // Tải lại danh sách&#10;            loadReturnVehicles();&#10;        }&#10;    })&#10;    .catch(error =&gt; {&#10;        alert('Lỗi khi trả xe: ' + error.message);&#10;    });&#10;}&#10;&#10;/**&#10; * Đóng modal khi click bên ngoài&#10; */&#10;window.onclick = function(event) {&#10;    const modal = document.getElementById('returnModal');&#10;    if (event.target == modal) {&#10;        modal.style.display = 'none';&#10;    }&#10;}&#10;&#10;/**&#10; * Tìm kiếm theo biển số xe (thời gian thực)&#10; */&#10;document.addEventListener('DOMContentLoaded', function() {&#10;    const searchPlateInput = document.getElementById('searchPlate');&#10;    if (searchPlateInput) {&#10;        searchPlateInput.addEventListener('keyup', function() {&#10;            filterTable();&#10;        });&#10;    }&#10;});&#10;&#10;/**&#10; * Tìm kiếm theo tên khách hàng (thời gian thực)&#10; */&#10;document.addEventListener('DOMContentLoaded', function() {&#10;    const searchCustomerInput = document.getElementById('searchCustomer');&#10;    if (searchCustomerInput) {&#10;        searchCustomerInput.addEventListener('keyup', function() {&#10;            filterTable();&#10;        });&#10;    }&#10;});&#10;&#10;/**&#10; * Hàm lọc bảng theo cả hai tiêu chí: biển số và tên khách hàng&#10; * Sử dụng logic AND - cả hai điều kiện phải match&#10; */&#10;function filterTable() {&#10;    const searchPlate = document.getElementById('searchPlate').value.toLowerCase();&#10;    const searchCustomer = document.getElementById('searchCustomer').value.toLowerCase();&#10;    const tableBody = document.getElementById('returnTableBody');&#10;    const rows = tableBody.getElementsByTagName('tr');&#10;&#10;    for (let row of rows) {&#10;        const cells = row.querySelectorAll('td');&#10;&#10;        if (cells.length &gt;= 3) {&#10;            // Cột 0: Biển số xe&#10;            const plate = cells[0].textContent.toLowerCase();&#10;            // Cột 2: Tên khách hàng (username từ RentalRecord)&#10;            const customerName = cells[2].textContent.toLowerCase();&#10;&#10;            const matchPlate = plate.includes(searchPlate);&#10;            const matchCustomer = customerName.includes(searchCustomer);&#10;&#10;            // Hiển thị dòng nếu cả hai điều kiện đều match (AND logic)&#10;            // Hoặc chỉ một nếu chỉ có một field được nhập&#10;            if ((searchPlate === '' || matchPlate) &amp;&amp; (searchCustomer === '' || matchCustomer)) {&#10;                row.style.display = '';&#10;            } else {&#10;                row.style.display = 'none';&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>