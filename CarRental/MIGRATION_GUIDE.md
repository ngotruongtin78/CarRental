# MongoDB to MySQL Migration Guide

## Overview
This guide documents the complete migration of the CarRental application from MongoDB to MySQL/JPA.

## Changes Summary

### 1. Dependencies (pom.xml)
**Removed:**
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-mongodb</artifactId>
</dependency>
```

**Added:**
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
<dependency>
    <groupId>com.mysql</groupId>
    <artifactId>mysql-connector-j</artifactId>
    <scope>runtime</scope>
</dependency>
```

### 2. Configuration (application.properties)
**Before (MongoDB):**
```properties
spring.data.mongodb.uri=mongodb+srv://...
spring.data.mongodb.database=carrental
```

**After (MySQL/JPA):**
```properties
spring.datasource.url=jdbc:mysql://localhost:3306/carrental?createDatabaseIfNotExist=true&useSSL=true&serverTimezone=UTC
spring.datasource.username=root
spring.datasource.password=
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect
spring.jpa.properties.hibernate.format_sql=true
```

### 3. Entity Classes

#### Primary Key Changes
**Before (MongoDB):**
```java
@Document(collection = "users")
public class User {
    @Id
    private String id;
    // ...
}
```

**After (JPA):**
```java
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    // ...
}
```

#### Foreign Key Changes
**Before (MongoDB):**
```java
private String userId;
private String vehicleId;
private String stationId;
```

**After (JPA):**
```java
private Long userId;
private Long vehicleId;
private Long stationId;
```

#### Binary Data Changes
**Before (MongoDB):**
```java
import org.bson.types.Binary;

@Field("license")
private Binary licenseData;
```

**After (JPA):**
```java
@Lob
@Column(columnDefinition = "LONGBLOB")
private byte[] licenseData;
```

### 4. Repository Changes

**Before (MongoDB):**
```java
public interface UserRepository extends MongoRepository<User, String> {
    User findByUsername(String username);
}
```

**After (JPA):**
```java
public interface UserRepository extends JpaRepository<User, Long> {
    User findByUsername(String username);
}
```

### 5. Query Changes

**Before (MongoDB):**
```java
@Query("{ 'stationId': ?0, 'available': true }")
List<Vehicle> findAvailableVehicles(String stationId);
```

**After (JPQL):**
```java
@Query("SELECT v FROM Vehicle v WHERE v.stationId = ?1 AND v.available = true")
List<Vehicle> findAvailableVehicles(Long stationId);
```

### 6. Removed Components
- `SequenceGeneratorService` - No longer needed with JPA auto-increment
- `Sequence` entity - No longer needed with JPA auto-increment

### 7. Controller Updates
- Removed MongoDB `Binary` type imports
- Updated to use `byte[]` for binary data
- Removed `BsonBinarySubType` usage

## Database Schema

The following tables will be auto-generated by Hibernate:

### Tables:
1. **users** - User accounts (customers and staff)
2. **staff** - Staff-specific data (extends users)
3. **vehicles** - Vehicle inventory
4. **stations** - Station locations
5. **rental_records** - Rental bookings and history
6. **reviews** - Customer reviews
7. **notifications** - User notifications
8. **vehicle_reports** - Vehicle issue reports
9. **customer_support** - Support tickets

### Key Column Types:
- **IDs**: `BIGINT AUTO_INCREMENT PRIMARY KEY`
- **Foreign Keys**: `BIGINT` 
- **Strings**: `VARCHAR(length)` with appropriate lengths
- **Booleans**: `TINYINT(1)`
- **Dates**: `DATE` for LocalDate, `DATETIME` for LocalDateTime
- **Binary Data**: `LONGBLOB` for images/documents
- **Decimals**: `DOUBLE` for prices and coordinates

## Setup Instructions

### Prerequisites
1. MySQL Server 8.0+ installed and running
2. Create database user with appropriate permissions

### Database Setup
```sql
CREATE DATABASE IF NOT EXISTS carrental CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS 'carrental_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON carrental.* TO 'carrental_user'@'localhost';
FLUSH PRIVILEGES;
```

### Application Configuration
Update `application.properties`:
```properties
spring.datasource.url=jdbc:mysql://localhost:3306/carrental?createDatabaseIfNotExist=true&useSSL=true
spring.datasource.username=carrental_user
spring.datasource.password=your_secure_password
```

### First Run
1. Build the application: `mvn clean compile`
2. Note: Some compilation errors remain in controllers (see MIGRATION_STATUS.md)
3. After fixing compilation errors, run: `mvn spring-boot:run`
4. Hibernate will automatically create all tables on first run
5. Verify tables created: `SHOW TABLES;` in MySQL

## Testing

### Verify Schema
```sql
USE carrental;
SHOW TABLES;
DESCRIBE users;
DESCRIBE vehicles;
DESCRIBE rental_records;
```

### Test Endpoints
1. Create a user account
2. Upload documents (license, ID card)
3. Book a rental
4. Verify data persists in MySQL

## Known Issues & Remaining Tasks

### Compilation Errors (~200 errors)
Controllers and services need String-to-Long ID conversions:
- Update `@PathVariable` and `@RequestParam` types
- Convert String IDs to Long before repository calls
- See MIGRATION_STATUS.md for detailed list

### Data Migration
If migrating existing MongoDB data:
1. Export from MongoDB: `mongoexport --db carrental --collection users --out users.json`
2. Transform ObjectId strings to sequential Long values
3. Import to MySQL using custom migration script
4. Update foreign key references

## Rollback Plan

To rollback to MongoDB:
1. Restore original `pom.xml` from git history
2. Restore original entity classes (@Document annotations)
3. Restore original repositories (MongoRepository)
4. Restore original application.properties (MongoDB config)
5. Run: `mvn clean install`

## Security Considerations

### Production Deployment
1. **Never** commit passwords to version control
2. Use environment variables for database credentials:
   ```properties
   spring.datasource.username=${DB_USERNAME}
   spring.datasource.password=${DB_PASSWORD}
   ```
3. Enable SSL/TLS for database connections
4. Use strong passwords for database users
5. Limit database user permissions to only what's needed
6. Regular security updates for MySQL server
7. Enable MySQL audit logging for production

### Connection Security
The current configuration enables SSL:
```properties
spring.datasource.url=jdbc:mysql://localhost:3306/carrental?...&useSSL=true
```

For production, also configure SSL certificates:
```properties
spring.datasource.url=jdbc:mysql://host:3306/carrental?useSSL=true&requireSSL=true&verifyServerCertificate=true
```

## Performance Considerations

1. **Indexes**: Add indexes on frequently queried columns
   ```sql
   CREATE INDEX idx_vehicles_station ON vehicles(stationId);
   CREATE INDEX idx_rentals_user ON rental_records(userId);
   CREATE INDEX idx_rentals_vehicle ON rental_records(vehicleId);
   ```

2. **Connection Pooling**: Configure HikariCP (default in Spring Boot)
   ```properties
   spring.datasource.hikari.maximum-pool-size=10
   spring.datasource.hikari.minimum-idle=5
   spring.datasource.hikari.connection-timeout=30000
   ```

3. **Query Optimization**: Use JPA Projections for read-only queries
4. **Caching**: Consider adding @Cacheable for frequently accessed data

## Support & Troubleshooting

### Common Issues

**Issue**: `Access denied for user 'root'@'localhost'`
**Solution**: Check MySQL user permissions and password

**Issue**: `Table doesn't exist`
**Solution**: Ensure `spring.jpa.hibernate.ddl-auto=update` is set

**Issue**: `Data too long for column`
**Solution**: Increase column length in entity @Column annotation

**Issue**: Binary data not saving
**Solution**: Verify @Lob annotation and LONGBLOB columnDefinition

## References

- [Spring Data JPA Documentation](https://spring.io/projects/spring-data-jpa)
- [Hibernate ORM Documentation](https://hibernate.org/orm/documentation/)
- [MySQL Documentation](https://dev.mysql.com/doc/)
- [Migration Best Practices](https://www.baeldung.com/spring-boot-data-sql-and-nosql)
