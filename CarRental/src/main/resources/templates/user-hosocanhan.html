<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ sơ cá nhân - EV Station</title>
    <link rel="stylesheet" href="/css/hosocanhan.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
<div class="main-container">
    <div class="sidebar">
        <div class="sidebar-header">EV Station</div>
        <ul class="sidebar-menu">
            <li><a href="/home"><i class="fas fa-home"></i> Trang chủ</a></li>
            <li><a href="/datxe"><i class="fas fa-bicycle"></i> Đặt xe</a></li>
            <li><a href="/lichsuthue"><i class="fas fa-history"></i> Lịch sử thuê</a></li>
            <li class="active"><a href="/ho-so"><i class="fas fa-user-circle"></i> Hồ sơ cá nhân</a></li>
        </ul>
    </div>

    <div class="content-area">

        <div class="top-bar">
            <div class="search-bar">
                <input id="station-search" type="text" placeholder="Tìm điểm thuê gần bạn">
                <button id="btn-find-station" type="button"><i class="fas fa-location-crosshairs"></i></button>
                <div id="station-hint" class="station-hint"></div>
            </div>
            <div class="auth-buttons">
                <div sec:authorize="isAnonymous()">
                    <a href="/login" class="btn-login">Đăng nhập</a>
                    <a href="/register" class="btn-register">Đăng ký</a>
                </div>

                <div class="user-info" sec:authorize="isAuthenticated()">
        <span class="welcome-text">
            Xin chào, <b sec:authentication="name"></b>
        </span>
                </div>
            </div>
        </div>


        <h1 class="page-title">Hồ sơ cá nhân</h1>

        <div class="card profile-card">
            <div class="profile-header">
                <div class="profile-avatar">
                    <i class="fas fa-user"></i>
                </div>

                <div class="profile-info">
                    <h2 id="pf-username">Đang tải...</h2>
                    <p id="pf-email"></p>
                </div>
            </div>

            <div class="profile-documents">
                <div class="doc-status" id="doc-status-text">Chưa tải giấy tờ</div>
                <div class="doc-actions">
                    <button class="doc-button" id="btn-license">
                        <i class="fas fa-upload"></i> Tải/Thay ảnh GPLX
                    </button>
                    <button class="doc-button danger" id="btn-license-delete">
                        <i class="fas fa-trash"></i> Xóa ảnh GPLX
                    </button>

                    <button class="doc-button" id="btn-idcard">
                        <i class="fas fa-upload"></i> Tải/Thay ảnh CCCD
                    </button>
                    <button class="doc-button danger" id="btn-idcard-delete">
                        <i class="fas fa-trash"></i> Xóa ảnh CCCD
                    </button>
                </div>
            </div>

            <div class="doc-preview">
                <div class="doc-preview-item">
                    <div class="preview-header">
                        <i class="fas fa-id-card"></i> Ảnh GPLX
                    </div>
                    <div class="preview-frame">
                        <img id="img-license" alt="GPLX" class="preview-img" />
                        <div id="placeholder-license" class="preview-placeholder">Chưa có ảnh</div>
                    </div>
                </div>

                <div class="doc-preview-item">
                    <div class="preview-header">
                        <i class="fas fa-passport"></i> Ảnh CCCD/CMND
                    </div>
                    <div class="preview-frame">
                        <img id="img-idcard" alt="CCCD" class="preview-img" />
                        <div id="placeholder-idcard" class="preview-placeholder">Chưa có ảnh</div>
                    </div>
                </div>
            </div>

            <div class="verification-box">
                <p id="verification-status" class="verification-text">Đang kiểm tra trạng thái xác thực...</p>
                <button id="btn-request-verification" class="doc-button secondary">Yêu cầu xác thực nhanh tại quầy</button>
            </div>
        </div>

        <div class="card activity-summary-card">
            <h2>Tóm tắt hoạt động</h2>
            <div class="activity-grid">
                <div class="activity-item">
                    <i class="fas fa-bicycle"></i>
                    <p class="activity-label">Tổng chuyến đi</p>
                    <p class="activity-value" id="stat-trips">0</p>
                </div>

                <div class="activity-item">
                    <i class="fas fa-road"></i>
                    <p class="activity-label">Thời gian TB/chuyến</p>
                    <p class="activity-value" id="stat-avg">0 ngày</p>
                </div>

                <div class="activity-item">
                    <i class="fas fa-dollar-sign"></i>
                    <p class="activity-label">Tổng chi</p>
                    <p class="activity-value" id="stat-spent">0 đ</p>
                </div>
            </div>
        </div>

        <div class="profile-actions">
            <a href="/logout" class="btn-logout" style="margin-top:10px;">
                <i class="fas fa-sign-out-alt"></i> Đăng xuất
            </a>
        </div>
    </div>
</div>

<script>
    async function loadProfile() {
        const res = await fetch("/api/renter/profile");
        const u = await res.json();

        document.getElementById("pf-username").innerText = u.username;
        document.getElementById("pf-email").innerHTML =
            `<i class='fas fa-envelope'></i> ${u.email ?? "Chưa cập nhật"}`;
    }

    async function loadStats() {
        const res = await fetch("/api/rental/stats");
        const s = await res.json();

        document.getElementById("stat-trips").innerText = s.totalTrips ?? 0;
        const avgDays = s.averageDurationMinutes ? (s.averageDurationMinutes / 1440).toFixed(1) : 0;
        document.getElementById("stat-avg").innerText = avgDays + " ngày";
        const spent = s.totalSpent ? s.totalSpent.toLocaleString('vi-VN') : 0;
        document.getElementById("stat-spent").innerText = spent + " đ";
    }

    function setPreviewState(imgEl, placeholderEl, hasData) {
        if (hasData) {
            placeholderEl.style.display = "none";
            imgEl.style.display = "block";
        } else {
            imgEl.style.display = "none";
            placeholderEl.style.display = "flex";
            imgEl.removeAttribute("src");
        }
    }

    async function loadDocumentImages(state) {
        const licenseImg = document.getElementById("img-license");
        const idImg = document.getElementById("img-idcard");
        const licensePlaceholder = document.getElementById("placeholder-license");
        const idPlaceholder = document.getElementById("placeholder-idcard");

        const updateImage = async (url, img, placeholder, hasData) => {
            setPreviewState(img, placeholder, hasData);
            if (!hasData) return;

            try {
                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error("Không tải được ảnh");
                }
                const blob = await res.blob();
                const objectUrl = URL.createObjectURL(blob);
                img.src = objectUrl;
            } catch (e) {
                console.error(e);
                placeholder.innerText = "Lỗi tải ảnh";
                setPreviewState(img, placeholder, false);
            }
        };

        await Promise.all([
            updateImage("/api/renter/license-image", licenseImg, licensePlaceholder, state.licenseUploaded),
            updateImage("/api/renter/idcard-image", idImg, idPlaceholder, state.idCardUploaded)
        ]);
    }

    function applyDocState(state) {
        const statusEl = document.getElementById("doc-status-text");
        const btnLicense = document.getElementById("btn-license");
        const btnId = document.getElementById("btn-idcard");
        const btnLicenseDelete = document.getElementById("btn-license-delete");
        const btnIdDelete = document.getElementById("btn-idcard-delete");
        const verifyStatusEl = document.getElementById("verification-status");
        const requestBtn = document.getElementById("btn-request-verification");

        if (state.licenseUploaded && state.idCardUploaded) {
            statusEl.innerText = "Đã tải đủ CCCD & GPLX";
            statusEl.style.color = "#2e7d32";
        } else {
            statusEl.innerText = "Thiếu giấy tờ: " +
                [!state.licenseUploaded ? "GPLX" : null, !state.idCardUploaded ? "CCCD" : null]
                    .filter(Boolean)
                    .join(", ");
            statusEl.style.color = "#c0392b";
        }

        btnLicenseDelete.style.display = state.licenseUploaded ? "inline-flex" : "none";
        btnIdDelete.style.display = state.idCardUploaded ? "inline-flex" : "none";
        btnLicense.innerHTML = state.licenseUploaded ? "<i class='fas fa-rotate'></i> Tải lại GPLX" : "<i class='fas fa-upload'></i> Tải ảnh GPLX";
        btnId.innerHTML = state.idCardUploaded ? "<i class='fas fa-rotate'></i> Tải lại CCCD" : "<i class='fas fa-upload'></i> Tải ảnh CCCD";

        if (state.verified) {
            verifyStatusEl.innerText = "Tài khoản đã được xác thực. Bạn có thể thuê và thanh toán nhanh.";
            verifyStatusEl.style.color = "#2e7d32";
            requestBtn.style.display = "none";
        } else if (state.verificationRequested) {
            verifyStatusEl.innerText = "Đã gửi yêu cầu xác thực. Vui lòng xuất trình giấy tờ tại quầy.";
            verifyStatusEl.style.color = "#c47a0b";
            requestBtn.disabled = true;
            requestBtn.innerText = "Đã yêu cầu xác thực";
        } else {
            verifyStatusEl.innerText = "Chưa xác thực. Nhấn để yêu cầu nhân viên kiểm tra giấy tờ tại trạm.";
            verifyStatusEl.style.color = "#c0392b";
            requestBtn.disabled = false;
            requestBtn.style.display = "inline-flex";
            requestBtn.innerText = "Yêu cầu xác thực nhanh tại quầy";
        }

        loadDocumentImages(state);
    }

    async function refreshDocs() {
        try {
            const res = await fetch("/api/renter/verification-status");
            if (!res.ok) return;
            const data = await res.json();
            applyDocState(data);
        } catch (e) {
            console.error("Không tải được trạng thái giấy tờ", e);
        }
    }

    async function requestVerification() {
        try {
            const res = await fetch("/api/renter/request-verification", { method: "POST" });
            if (res.ok) {
                alert("Đã gửi yêu cầu xác thực. Vui lòng gặp nhân viên tại quầy.");
                refreshDocs();
            } else {
                const text = await res.text();
                alert(text || "Không gửi được yêu cầu, thử lại sau.");
            }
        } catch (e) {
            alert("Không gửi được yêu cầu xác thực.");
        }
    }

    function upload(type) {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";

        input.onchange = async () => {
            const form = new FormData();
            form.append("file", input.files[0]);

            const res = await fetch(`/api/renter/upload-${type}`, {
                method: "POST",
                body: form
            });

            if (res.ok) {
                alert("Tải lên thành công!");
                refreshDocs();
            } else {
                const msg = await res.text();
                alert(msg || "Tải lên thất bại, vui lòng thử lại.");
            }
        };
        input.click();
    }

    async function deleteDocument(type) {
        if (!confirm("Xóa ảnh đã tải lên?")) return;
        try {
            const res = await fetch(`/api/renter/delete-${type}`, { method: "DELETE" });
            if (res.ok) {
                alert("Đã xóa ảnh");
                refreshDocs();
            } else {
                const msg = await res.text();
                alert(msg || "Không xóa được ảnh, thử lại sau.");
            }
        } catch (e) {
            alert("Không xóa được ảnh, thử lại sau.");
        }
    }

    document.getElementById("btn-license").onclick = () => upload("license");
    document.getElementById("btn-idcard").onclick = () => upload("idcard");
    document.getElementById("btn-license-delete").onclick = () => deleteDocument("license");
    document.getElementById("btn-idcard-delete").onclick = () => deleteDocument("idcard");
    document.getElementById("btn-request-verification").onclick = requestVerification;

    loadProfile();
    loadStats();
    refreshDocs();
</script>

<script src="/js/station-search.js"></script>

</body>
</html>
