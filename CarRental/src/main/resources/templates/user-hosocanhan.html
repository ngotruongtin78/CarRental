<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ sơ cá nhân - EV Station</title>
    <link rel="stylesheet" href="/css/hosocanhan.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* 1. FIX MÀU CHỮ NỘI DUNG (Tránh lỗi chữ trắng trên nền trắng) */
        body { color: #333; }
        .card, .modal-content, .profile-info h2, .activity-value, h1, h2, h3, p, div, span {
            color: #333;
        }

        /* 2. Ô nhập liệu: Ép chữ đen, nền trắng */
        input, textarea, select {
            color: #000 !important;
            background-color: #fff !important;
            border: 1px solid #ccc;
        }
        ::placeholder { color: #888 !important; opacity: 1; }

        /* --- 3. HEADER / TOP BAR CHUẨN (Giống trang chủ) --- */
        .top-bar {
            color: #fff !important; /* Chữ trên thanh này phải màu trắng */
        }

        .user-menu {
            position: relative;
            display: inline-block;
        }

        /* Nút chứa Avatar và Tên */
        .user-menu-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 20px;
            transition: background 0.2s;
        }

        .user-menu-toggle:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Chữ "Xin chào..." */
        .user-menu-toggle .welcome-text {
            color: #fff !important;
            font-size: 14px;
            font-weight: 500;
        }

        /* Avatar tròn */
        .user-menu-toggle .avatar-circle {
            width: 35px;
            height: 35px;
            background-color: #fff !important;
            color: #2f6b2f !important; /* Màu xanh lá đậm */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .user-menu-toggle i.fa-chevron-down {
            color: #fff !important;
            font-size: 12px;
        }

        /* Menu xổ xuống */
        .user-menu-dropdown {
            display: none; /* Mặc định ẩn */
            position: absolute;
            right: 0;
            top: 110%; /* Đẩy xuống dưới nút */
            background-color: #fff !important;
            min-width: 160px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            z-index: 1000;
            overflow: hidden;
        }

        /* Class để hiện menu */
        .user-menu-dropdown.show {
            display: block;
        }

        .user-menu-dropdown a {
            color: #333 !important;
            padding: 12px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            transition: background 0.2s;
        }

        .user-menu-dropdown a:hover {
            background-color: #f5f5f5 !important;
        }

        .user-menu-dropdown a.logout {
            color: #d32f2f !important; /* Màu đỏ cho đăng xuất */
            border-top: 1px solid #eee;
        }
    </style>
</head>

<body>
<div class="main-container">
    <div class="sidebar">
        <div class="sidebar-header" style="color: #388e3c !important;">EV Station</div>
        <ul class="sidebar-menu">
            <li><a href="/home"><i class="fas fa-home"></i> Trang chủ</a></li>
            <li><a href="/datxe"><i class="fas fa-bicycle"></i> Đặt xe</a></li>
            <li><a href="/lichsuthue"><i class="fas fa-history"></i> Lịch sử thuê</a></li>
            <li class="active"><a href="/ho-so"><i class="fas fa-user-circle"></i> Hồ sơ cá nhân</a></li>
        </ul>
    </div>

    <div class="content-area">
        <div class="top-bar">
            <div class="search-bar">
                <input id="station-search" type="text" placeholder="Tìm điểm thuê gần bạn">
                <button id="btn-find-station" type="button"><i class="fas fa-location-crosshairs"></i></button>
                <div id="station-hint" class="station-hint"></div>
            </div>

            <div class="auth-buttons">
                <div sec:authorize="isAnonymous()">
                    <a href="/login" class="btn-login">Đăng nhập</a>
                    <a href="/register" class="btn-register">Đăng ký</a>
                </div>

                <div class="user-menu" sec:authorize="isAuthenticated()">
                    <button class="user-menu-toggle" onclick="toggleUserMenu(event)">
                        <span class="welcome-text">Xin chào, <b sec:authentication="name">User</b></span>
                        <div class="avatar-circle">
                            <i class="fas fa-user"></i>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </button>

                    <div class="user-menu-dropdown" id="userDropdown">
                        <a href="/logout" class="logout">
                            <i class="fas fa-sign-out-alt"></i> Đăng xuất
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <h1 class="page-title" style="color:#333 !important;">Hồ sơ cá nhân</h1>

        <div class="card profile-card">
            <div class="profile-header">
                <div class="profile-avatar"><i class="fas fa-user"></i></div>
                <div class="profile-info">
                    <h2 id="pf-username" style="color:#333;">Đang tải...</h2>
                    <p id="pf-email" style="color:#666;"></p>
                </div>
            </div>
            <div class="profile-documents">
                <div class="doc-status" id="doc-status-text" style="color:#333;">Chưa tải giấy tờ</div>
                <div class="doc-actions">
                    <button class="doc-button" id="btn-license"><i class="fas fa-upload"></i> Giấy phép lái xe</button>
                    <button class="doc-button" id="btn-idcard"><i class="fas fa-upload"></i> CMND/CCCD</button>
                </div>
            </div>
            <div class="verification-box">
                <p id="verification-status" class="verification-text" style="color:#555;">Đang kiểm tra trạng thái xác thực...</p>
                <button id="btn-request-verification" class="doc-button secondary">Yêu cầu xác thực nhanh tại quầy</button>
            </div>
        </div>

        <div class="card activity-summary-card">
            <h2 style="color:#333;">Tóm tắt hoạt động</h2>
            <div class="activity-grid">
                <div class="activity-item">
                    <i class="fas fa-bicycle"></i>
                    <p class="activity-label" style="color:#666;">Tổng chuyến đi</p>
                    <p class="activity-value" id="stat-trips" style="color:#333;">0</p>
                </div>
                <div class="activity-item">
                    <i class="fas fa-road"></i>
                    <p class="activity-label" style="color:#666;">Thời gian TB/chuyến</p>
                    <p class="activity-value" id="stat-avg" style="color:#333;">0 ngày</p>
                </div>
                <div class="activity-item">
                    <i class="fas fa-dollar-sign"></i>
                    <p class="activity-label" style="color:#666;">Tổng chi</p>
                    <p class="activity-value" id="stat-spent" style="color:#333;">0 đ</p>
                </div>
            </div>
        </div>

        <div class="card support-card" style="margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin:0; font-size:24px; color:#333;">Hỗ trợ & Khiếu nại</h2>
                <button class="doc-button secondary" onclick="openSupportModal()" style="background:#388e3c; color:white; border:none;">+ Gửi yêu cầu mới</button>
            </div>
            <div id="support-list" style="display: flex; flex-direction: column; gap: 15px;">
                <p style="text-align: center; color: #777;">Đang tải lịch sử hỗ trợ...</p>
            </div>
        </div>

        <!-- Notifications Section -->
        <div class="card notification-card" style="margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <h2 style="margin:0; font-size:24px; color:#333;">Thông báo</h2>
                    <span id="notification-badge" class="notification-badge" style="display: none; background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;">0</span>
                </div>
                <button class="doc-button secondary" id="btn-mark-all-read" onclick="markAllNotificationsRead()" style="background:#3498db; color:white; border:none; font-size: 12px; padding: 8px 12px;">Đánh dấu tất cả đã đọc</button>
            </div>
            <div id="notification-list" style="display: flex; flex-direction: column; gap: 10px;">
                <p style="text-align: center; color: #777;">Đang tải thông báo...</p>
            </div>
        </div>

        <div class="profile-actions">
            <a href="/logout" class="btn-logout" style="margin-top:10px;"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
        </div>
    </div>
</div>

<div id="supportModal" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; color: #333;">
        <h3 style="margin-top:0; color: #333;">Gửi khiếu nại / Hỗ trợ</h3>
        <div style="margin-bottom: 15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">Tiêu đề</label>
            <input type="text" id="supportTitle" placeholder="Vd: Khiếu nại chuyến đi #123" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; color: #333;">
        </div>
        <div style="margin-bottom: 20px;">
            <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">Nội dung chi tiết</label>
            <textarea id="supportContent" rows="4" placeholder="Mô tả vấn đề của bạn..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; font-family:inherit; color: #333;"></textarea>
        </div>
        <div style="text-align: right;">
            <button onclick="document.getElementById('supportModal').style.display='none'" class="doc-button" style="color:#333;">Hủy</button>
            <button onclick="submitSupport()" class="doc-button secondary" style="background: #388e3c; color: white; border: none;">Gửi ngay</button>
        </div>
    </div>
</div>

<script>
    // --- LOGIC MENU USER (TOGGLE) ---
    function toggleUserMenu(event) {
        event.stopPropagation(); // Ngăn chặn sự kiện click lan ra ngoài
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.toggle('show');
    }

    // Đóng menu khi click ra ngoài
    window.addEventListener('click', function(event) {
        const dropdown = document.getElementById('userDropdown');
        const toggleBtn = document.querySelector('.user-menu-toggle');

        // Nếu click không trúng menu và không trúng nút toggle
        if (dropdown && !dropdown.contains(event.target) && !toggleBtn.contains(event.target)) {
            dropdown.classList.remove('show');
        }
    });

    // --- LOGIC PROFILE (Giữ nguyên) ---
    async function loadProfile() {
        try {
            const res = await fetch("/api/renter/profile");
            const u = await res.json();
            document.getElementById("pf-username").innerText = u.username;
            document.getElementById("pf-email").innerHTML = `<i class='fas fa-envelope'></i> ${u.email ?? "Chưa cập nhật"}`;
        } catch(e) { console.error(e); }
    }

    async function loadStats() {
        try {
            const res = await fetch("/api/rental/stats");
            const s = await res.json();
            document.getElementById("stat-trips").innerText = s.totalTrips ?? 0;
            const avgDays = s.averageDurationMinutes ? (s.averageDurationMinutes / 1440).toFixed(1) : 0;
            document.getElementById("stat-avg").innerText = avgDays + " ngày";
            const spent = s.totalSpent ? s.totalSpent.toLocaleString('vi-VN') : 0;
            document.getElementById("stat-spent").innerText = spent + " đ";
        } catch(e) { console.error(e); }
    }

    function applyDocState(state) {
        const statusEl = document.getElementById("doc-status-text");
        const btnLicense = document.getElementById("btn-license");
        const btnId = document.getElementById("btn-idcard");
        const verifyStatusEl = document.getElementById("verification-status");
        const requestBtn = document.getElementById("btn-request-verification");

        if (state.licenseUploaded && state.idCardUploaded) {
            statusEl.innerText = "Đã tải đủ CCCD & GPLX";
            statusEl.style.color = "#2e7d32";
            btnLicense.style.display = "none";
            btnId.style.display = "none";
        } else {
            statusEl.innerText = "Thiếu giấy tờ: " +
                [!state.licenseUploaded ? "GPLX" : null, !state.idCardUploaded ? "CCCD" : null].filter(Boolean).join(", ");
            statusEl.style.color = "#c0392b";
            btnLicense.style.display = state.licenseUploaded ? "none" : "inline-flex";
            btnId.style.display = state.idCardUploaded ? "none" : "inline-flex";
        }

        if (state.verified) {
            verifyStatusEl.innerText = "Tài khoản đã được xác thực.";
            verifyStatusEl.style.color = "#2e7d32";
            requestBtn.style.display = "none";
        } else if (state.verificationRequested) {
            verifyStatusEl.innerText = "Đã gửi yêu cầu xác thực.";
            verifyStatusEl.style.color = "#c47a0b";
            requestBtn.disabled = true;
            requestBtn.innerText = "Đã yêu cầu xác thực";
        } else {
            verifyStatusEl.innerText = "Chưa xác thực.";
            verifyStatusEl.style.color = "#c0392b";
            requestBtn.disabled = false;
            requestBtn.style.display = "inline-flex";
            requestBtn.innerText = "Yêu cầu xác thực nhanh tại quầy";
        }
    }

    async function refreshDocs() {
        try {
            const res = await fetch("/api/renter/verification-status");
            if (!res.ok) return;
            const data = await res.json();
            applyDocState(data);
        } catch (e) {}
    }

    async function requestVerification() {
        try {
            const res = await fetch("/api/renter/request-verification", { method: "POST" });
            if (res.ok) {
                alert("Đã gửi yêu cầu xác thực.");
                refreshDocs();
            } else alert("Không gửi được yêu cầu.");
        } catch (e) { alert("Lỗi kết nối."); }
    }

    function upload(type) {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.onchange = async () => {
            const form = new FormData();
            form.append("file", input.files[0]);
            const res = await fetch(`/api/renter/upload-${type}`, { method: "POST", body: form });
            if (res.ok) { alert("Tải lên thành công!"); refreshDocs(); }
            else { alert("Tải lên thất bại"); }
        };
        input.click();
    }

    // --- LOGIC SUPPORT ---
    function openSupportModal() {
        document.getElementById('supportModal').style.display = 'flex';
    }

    async function submitSupport() {
        const title = document.getElementById('supportTitle').value;
        const content = document.getElementById('supportContent').value;
        if (!title || !content) return alert("Vui lòng nhập đầy đủ thông tin.");

        try {
            const res = await fetch('/api/support/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, content })
            });
            if (res.ok) {
                alert("Đã gửi yêu cầu thành công!");
                document.getElementById('supportModal').style.display = 'none';
                document.getElementById('supportTitle').value = '';
                document.getElementById('supportContent').value = '';
                loadSupportHistory();
            } else alert("Lỗi khi gửi yêu cầu.");
        } catch (e) { alert("Lỗi kết nối."); }
    }

    async function loadSupportHistory() {
        const container = document.getElementById('support-list');
        try {
            const res = await fetch('/api/support/my-history');
            if(!res.ok) return;
            const list = await res.json();

            if (list.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Bạn chưa có yêu cầu hỗ trợ nào.</p>';
                return;
            }

            container.innerHTML = list.map(item => `
                <div style="border: 1px solid #eee; padding: 15px; border-radius: 8px; background: #fdfdfd; color: #333;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <strong style="color:#333; font-size:16px;">${item.title}</strong>
                        <span style="font-size:12px; padding:4px 8px; border-radius:10px; background:${item.status === 'RESOLVED' ? '#e6f7f0' : '#fff3cd'}; color:${item.status === 'RESOLVED' ? '#008a4c' : '#856404'}; font-weight:bold;">
                            ${item.status === 'RESOLVED' ? 'Đã xử lý' : 'Đang chờ'}
                        </span>
                    </div>
                    <p style="color:#666; font-size:14px; margin:0;">${item.content}</p>
                    ${item.adminReply ? `
                        <div style="margin-top:10px; padding:10px; background:#f0f7ff; border-radius:6px; border-left:3px solid #2196F3;">
                            <strong style="color:#2196F3; font-size:13px;">Phản hồi từ Admin:</strong>
                            <p style="margin:5px 0 0; color:#333; font-size:14px;">${item.adminReply}</p>
                        </div>
                    ` : ''}
                    <div style="margin-top:8px; font-size:12px; color:#aaa; text-align:right;">${new Date(item.createdAt).toLocaleString('vi-VN')}</div>
                </div>
            `).join('');
        } catch (e) { container.innerHTML = '<p>Lỗi tải dữ liệu.</p>'; }
    }

    document.getElementById("btn-license").onclick = () => upload("license");
    document.getElementById("btn-idcard").onclick = () => upload("idcard");
    document.getElementById("btn-request-verification").onclick = requestVerification;

    // --- NOTIFICATION FUNCTIONS ---
    async function loadNotifications() {
        const container = document.getElementById('notification-list');
        const badge = document.getElementById('notification-badge');
        const markAllBtn = document.getElementById('btn-mark-all-read');
        
        try {
            const res = await fetch('/api/notifications');
            if (!res.ok) return;
            const notifications = await res.json();
            
            // Get unread count
            const countRes = await fetch('/api/notifications/unread-count');
            if (countRes.ok) {
                const countData = await countRes.json();
                if (countData.count > 0) {
                    badge.style.display = 'inline-block';
                    badge.textContent = countData.count;
                    markAllBtn.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                    markAllBtn.style.display = 'none';
                }
            }
            
            if (notifications.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Bạn chưa có thông báo nào.</p>';
                return;
            }
            
            container.innerHTML = notifications.map(notif => `
                <div class="notification-item" style="border: 1px solid ${notif.read ? '#eee' : '#3498db'}; padding: 12px 15px; border-radius: 8px; background: ${notif.read ? '#fdfdfd' : '#f0f7ff'}; color: #333; cursor: pointer; transition: all 0.2s;" onclick="markNotificationRead('${notif.id}', this)">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas ${notif.type === 'SUPPORT_REPLY' ? 'fa-headset' : 'fa-bell'}" style="color: ${notif.read ? '#999' : '#3498db'};"></i>
                                <p style="margin: 0; font-size: 14px; color: ${notif.read ? '#666' : '#333'}; font-weight: ${notif.read ? 'normal' : '500'};">${notif.message}</p>
                            </div>
                            <div style="margin-top: 6px; font-size: 11px; color: #aaa; margin-left: 24px;">
                                ${new Date(notif.createdDate).toLocaleString('vi-VN')}
                                ${!notif.read ? '<span style="margin-left: 8px; color: #3498db; font-weight: bold;">• Mới</span>' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (e) { 
            console.error(e);
            container.innerHTML = '<p style="color: #999; text-align: center;">Lỗi tải thông báo.</p>'; 
        }
    }
    
    async function markNotificationRead(id, element) {
        try {
            await fetch(`/api/notifications/mark-read/${id}`, { method: 'POST' });
            // Update UI
            if (element) {
                element.style.background = '#fdfdfd';
                element.style.borderColor = '#eee';
                element.querySelector('i').style.color = '#999';
                element.querySelector('p').style.color = '#666';
                element.querySelector('p').style.fontWeight = 'normal';
                const newBadge = element.querySelector('span[style*="color: #3498db"]');
                if (newBadge) newBadge.remove();
            }
            // Update badge count
            const countRes = await fetch('/api/notifications/unread-count');
            if (countRes.ok) {
                const countData = await countRes.json();
                const badge = document.getElementById('notification-badge');
                if (countData.count > 0) {
                    badge.style.display = 'inline-block';
                    badge.textContent = countData.count;
                } else {
                    badge.style.display = 'none';
                    document.getElementById('btn-mark-all-read').style.display = 'none';
                }
            }
        } catch (e) { console.error(e); }
    }
    
    async function markAllNotificationsRead() {
        try {
            await fetch('/api/notifications/mark-all-read', { method: 'POST' });
            loadNotifications();
        } catch (e) { console.error(e); }
    }

    loadProfile();
    loadStats();
    refreshDocs();
    loadSupportHistory();
    loadNotifications();
</script>
<script src="/js/station-search.js"></script>
</body>
</html>