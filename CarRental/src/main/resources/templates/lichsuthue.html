<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch sử thuê - EV Station</title>
    <link rel="stylesheet" th:href="@{/css/lichsuthue.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>
<div class="main-container">
    <div class="sidebar">
        <div class="sidebar-header">EV Station</div>
        <ul class="sidebar-menu">
            <li><a th:href="@{/home}"><i class="fas fa-home"></i> Trang chủ</a></li>
            <li><a th:href="@{/datxe}"><i class="fas fa-bicycle"></i> Đặt xe</a></li>
            <li class="active"><a href="#"><i class="fas fa-history"></i> Lịch sử thuê</a></li>
            <li><a th:href="@{/ho-so}"><i class="fas fa-user-circle"></i> Hồ sơ cá nhân</a></li>
        </ul>
    </div>

    <div class="content-area">
        <div class="top-bar">
            <div class="search-bar">
                <input id="station-search" type="text" placeholder="Tìm điểm thuê gần bạn">
                <button id="btn-find-station" type="button"><i class="fas fa-location-crosshairs"></i></button>
                <div id="station-hint" class="station-hint"></div>
            </div>
            <div class="auth-buttons">
                <div sec:authorize="isAnonymous()">
                    <a th:href="@{/login}" class="btn-login">Đăng nhập</a>
                    <a th:href="@{/register}" class="btn-register">Đăng ký</a>
                </div>

                <div class="user-menu" sec:authorize="isAuthenticated()">
                    <button class="user-menu-toggle" type="button">
                        <span class="welcome-text">Xin chào, <b th:text="${#authentication?.name}">---</b></span>
                        <span class="avatar-circle"><i class="fas fa-user"></i></span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-menu-dropdown">
                        <a href="/logout" class="dropdown-item logout">
                            <i class="fas fa-sign-out-alt"></i> Đăng xuất
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <h1 class="page-title">Lịch sử thuê xe</h1>

        <div class="card history-filter-card">
            <h2>Lọc lịch sử</h2>
            <div class="filter-group">
                <label for="period-filter">Thời gian:</label>
                <select id="period-filter" class="form-select">
                    <option value="all">Tất cả</option>
                    <option value="last7days">7 ngày qua</option>
                    <option value="last30days">30 ngày qua</option>
                    <option value="thismonth">Tháng này</option>
                    <option value="lastmonth">Tháng trước</option>
                    <option value="thisyear">Năm nay</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="vehicle-type-filter">Loại xe:</label>
                <select id="vehicle-type-filter" class="form-select">
                    <option value="all">Tất cả</option>
                    <option value="oto4">Ô tô 4 chỗ</option>
                    <option value="oto7">Ô tô 7 chỗ</option>
                    <option value="xe_may_dien">Xe máy điện</option>
                    <option value="xe_tay_ga_dien">Xe tay ga điện</option>
                    <option value="xe_dap_dien">Xe đạp điện</option>
                </select>
            </div>
                    <div class="filter-group">
                        <label for="status-filter">Trạng thái:</label>
                        <select id="status-filter" class="form-select">
                            <option value="all">Tất cả</option>
                            <option value="rented">Đang chờ thanh toán</option>
                            <option value="active">Đang thuê</option>
                            <option value="returned">Đã trả xe</option>
                        </select>
                    </div>
            <button class="btn-filter"><i class="fas fa-filter"></i> Áp dụng</button>
        </div>

        <div class="card rental-history-list">
            <h2>Các chuyến thuê của bạn</h2>
            <div id="history-list"></div>
        </div>

        <div class="card analytics-summary-card">
            <h2>Thống kê sử dụng</h2>
            <div class="analytics-grid">
                <div class="analytic-item">
                    <i class="fas fa-bicycle"></i>
                    <p class="analytic-label">Tổng số chuyến</p>
                    <p class="analytic-value" id="total-trips">0</p>
                </div>
                <div class="analytic-item">
                    <i class="fas fa-dollar-sign"></i>
                    <p class="analytic-label">Tổng chi phí</p>
                    <p class="analytic-value" id="total-spent">0 <small>VNĐ</small></p>
                </div>
                <div class="analytic-item">
                    <i class="fas fa-clock"></i>
                    <p class="analytic-label">Thời gian trung bình</p>
                    <p class="analytic-value" id="avg-duration">0 <small>ngày</small></p>
                </div>
                <div class="analytic-item">
                    <i class="fas fa-road"></i>
                    <p class="analytic-label">Tổng quãng đường</p>
                    <p class="analytic-value" id="total-distance">0 <small>km</small></p>
                </div>
                <div class="analytic-item full-row">
                    <i class="fas fa-chart-line"></i>
                    <p class="analytic-label">Khung giờ thường thuê</p>
                    <p class="analytic-value" id="peak-hours">-</p>
                </div>
            </div>
        </div>

    </div>
</div>
<div id="rental-modal" class="rental-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <button class="modal-close" type="button" aria-label="Đóng">&times;</button>
        <div class="modal-header">
            <div>
                <p class="modal-subtitle">Chi tiết chuyến thuê</p>
                <h3 class="modal-title" id="modal-title">Chuyến thuê</h3>
            </div>
            <div class="modal-badges" id="modal-badges"></div>
        </div>
        <div id="modal-body"></div>
    </div>
</div>
<div id="contract-modal" class="dialog-modal">
    <div class="dialog-overlay"></div>
    <div class="dialog-content">
        <div class="dialog-header">
            <h3>Hợp đồng thuê xe & Chính sách</h3>
            <button class="dialog-close" type="button" aria-label="Đóng">&times;</button>
        </div>
        <div class="dialog-body" id="contract-body"></div>
        <div class="dialog-actions">
            <button type="button" class="btn-primary" id="btn-contract-accept">Chấp thuận</button>
            <button type="button" class="btn-tertiary" id="btn-contract-cancel">Hủy</button>
        </div>
    </div>
</div>

<div id="checkin-modal" class="dialog-modal">
    <div class="dialog-overlay"></div>
    <div class="dialog-content wide">
        <div class="dialog-header">
            <h3>Check-in nhận xe</h3>
            <button class="dialog-close" type="button" aria-label="Đóng">&times;</button>
        </div>
        <div class="dialog-body">
            <p class="dialog-hint">Hệ thống sẽ lấy vị trí hiện tại và chỉ cho check-in khi bạn đang ở đúng trạm (bán kính 50m). Chụp ảnh hoặc tải ảnh lên để xác nhận tình trạng hiện tại của xe.</p>
            <div class="upload-grid">
                <div class="upload-box">
                    <label for="checkin-photo" class="upload-label">Ảnh check-in</label>
                    <input type="file" id="checkin-photo" accept="image/*" capture="environment">
                    <div class="preview" id="checkin-preview" aria-live="polite"></div>
                </div>
                <div class="upload-box">
                    <label for="checkin-notes" class="upload-label">Ghi chú tình trạng xe (tùy chọn)</label>
                    <textarea id="checkin-notes" rows="5" placeholder="Ví dụ: Xe không trầy xước, đủ phụ kiện..."></textarea>
                </div>
            </div>
        </div>
        <div class="dialog-actions">
            <button type="button" class="btn-primary" id="btn-checkin-confirm">Xác nhận check-in</button>
            <button type="button" class="btn-tertiary" id="btn-checkin-cancel">Hủy</button>
        </div>
    </div>
</div>
<div id="return-modal" class="dialog-modal">
    <div class="dialog-overlay"></div>
    <div class="dialog-content wide">
        <div class="dialog-header">
            <h3>Trả xe tại trạm</h3>
            <button class="dialog-close" type="button" aria-label="Đóng">&times;</button>
        </div>
        <div class="dialog-body">
            <p class="dialog-hint">Hệ thống sẽ tự động lấy vị trí hiện tại của bạn. Chỉ gửi yêu cầu trả xe khi đang đứng tại trạm (bán kính 50m) và hãy chụp ảnh tình trạng xe.</p>
            <div class="upload-grid">
                <div class="upload-box">
                    <label for="return-photo" class="upload-label">Ảnh trả xe</label>
                    <input type="file" id="return-photo" accept="image/*" capture="environment">
                    <div class="preview" id="return-preview" aria-live="polite"></div>
                </div>
                <div class="upload-box">
                    <label for="return-notes" class="upload-label">Ghi chú tình trạng xe sau khi trả</label>
                    <textarea id="return-notes" rows="5" placeholder="Ví dụ: Xe sạch sẽ, không hư hỏng..."></textarea>
                </div>
            </div>
        </div>
        <div class="dialog-actions">
            <button type="button" class="btn-primary" id="btn-return-confirm">Xác nhận trả xe</button>
            <button type="button" class="btn-tertiary" id="btn-return-cancel">Hủy</button>
        </div>
    </div>
</div>
<div id="extra-fee-modal" class="dialog-modal">
    <div class="dialog-overlay"></div>
    <div class="dialog-content">
        <div class="dialog-header">
            <h3>Thanh toán phí phát sinh</h3>
            <button class="dialog-close" type="button" aria-label="Đóng">&times;</button>
        </div>
        <div class="dialog-body">
            <p class="dialog-hint extra-fee-note" id="extra-fee-note">Phí phát sinh do nhân viên xác nhận.</p>
            <div class="qr-wrapper">
                <img id="extra-fee-qr" alt="QR thanh toán" src="" />
            </div>
            <div class="qr-meta">
                <p><strong>Số tiền:</strong> <span id="extra-fee-amount">-</span></p>
                <p><strong>Nội dung chuyển khoản:</strong> <span id="extra-fee-desc">-</span></p>
            </div>
        </div>
        <div class="dialog-actions">
            <button type="button" class="btn-primary" id="btn-extra-fee-close">Đóng</button>
        </div>
    </div>
</div>
<div id="edit-dates-modal" class="dialog-modal">
    <div class="dialog-overlay"></div>
    <div class="dialog-content">
        <div class="dialog-header">
            <h3>Chỉnh sửa ngày thuê</h3>
            <button class="dialog-close" type="button" aria-label="Đóng">&times;</button>
        </div>
        <div class="dialog-body">
            <p class="dialog-hint">Chỉ thay đổi được khi chuyến chưa bắt đầu và chưa check-in.</p>
            <div class="edit-dates-grid">
                <div class="form-field">
                    <label for="edit-start-date">Ngày bắt đầu</label>
                    <input type="date" id="edit-start-date">
                </div>
                <div class="form-field">
                    <label for="edit-end-date">Ngày kết thúc</label>
                    <input type="date" id="edit-end-date">
                </div>
            </div>
        </div>
        <div class="dialog-actions">
            <button type="button" class="btn-primary" id="btn-edit-dates-confirm">Lưu thay đổi</button>
            <button type="button" class="btn-tertiary" id="btn-edit-dates-cancel">Hủy</button>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div id="review-modal" class="dialog-modal">
    <div class="dialog-overlay"></div>
    <div class="dialog-content" style="max-width: 500px;">
        <div class="dialog-header">
            <h3>Đánh giá chuyến thuê</h3>
            <button class="dialog-close" type="button" aria-label="Đóng">&times;</button>
        </div>
        <div class="dialog-body">
            <p class="dialog-hint">Đánh giá trải nghiệm thuê xe của bạn để giúp chúng tôi cải thiện dịch vụ.</p>
            
            <!-- Car Rating -->
            <div class="review-rating-group" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                    <i class="fas fa-car" style="margin-right: 5px; color: #3498db;"></i>Đánh giá xe
                </label>
                <div class="star-rating" id="car-rating">
                    <i class="fas fa-star" data-rating="1"></i>
                    <i class="fas fa-star" data-rating="2"></i>
                    <i class="fas fa-star" data-rating="3"></i>
                    <i class="fas fa-star" data-rating="4"></i>
                    <i class="fas fa-star" data-rating="5"></i>
                </div>
                <input type="hidden" id="car-rating-value" value="0">
            </div>
            
            <!-- Staff Rating -->
            <div class="review-rating-group" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                    <i class="fas fa-user-tie" style="margin-right: 5px; color: #27ae60;"></i>Đánh giá nhân viên
                </label>
                <div class="star-rating" id="staff-rating">
                    <i class="fas fa-star" data-rating="1"></i>
                    <i class="fas fa-star" data-rating="2"></i>
                    <i class="fas fa-star" data-rating="3"></i>
                    <i class="fas fa-star" data-rating="4"></i>
                    <i class="fas fa-star" data-rating="5"></i>
                </div>
                <input type="hidden" id="staff-rating-value" value="0">
            </div>
            
            <!-- Comment -->
            <div class="review-comment-group" style="margin-bottom: 15px;">
                <label for="review-comment" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                    <i class="fas fa-comment" style="margin-right: 5px; color: #9b59b6;"></i>Bình luận (tùy chọn)
                </label>
                <textarea id="review-comment" rows="4" placeholder="Chia sẻ trải nghiệm của bạn..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; resize: vertical; font-family: inherit; font-size: 14px; color: #333;"></textarea>
            </div>
            
            <input type="hidden" id="review-booking-id">
            <input type="hidden" id="review-car-id">
            <input type="hidden" id="review-staff-id">
        </div>
        <div class="dialog-actions">
            <button type="button" class="btn-primary" id="btn-review-submit">
                <i class="fas fa-paper-plane"></i> Gửi đánh giá
            </button>
            <button type="button" class="btn-tertiary" id="btn-review-cancel">Hủy</button>
        </div>
    </div>
</div>

<style>
    .star-rating {
        display: flex;
        gap: 8px;
        font-size: 28px;
    }
    .star-rating i {
        color: #ddd;
        cursor: pointer;
        transition: all 0.2s;
    }
    .star-rating i:hover,
    .star-rating i.hover {
        color: #f1c40f;
        transform: scale(1.1);
    }
    .star-rating i.active {
        color: #f1c40f;
    }
    .btn-review {
        background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
    }
    .btn-review:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(241, 196, 15, 0.4);
    }
    .btn-review:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    .reviewed-badge {
        background: #e8f5e9;
        color: #2e7d32;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
</style>

<script src="/js/user-menu.js"></script>
<script src="/js/station-search.js"></script>
<script src="/js/lichsuthue.js"></script>
<script src="/js/review.js"></script>
</body>
</html>